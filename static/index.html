<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Material Search Engine</title>
    <link rel="stylesheet" href="static/assets/index.css"/>
    <script src="static/assets/vue.global.prod.js"></script>
    <script src="static/assets/vue-i18n.global.prod.js"></script>
    <script src="static/assets/index.full.min.js"></script>
    <script src="static/assets/index.iife.min.js"></script>
    <script src="static/assets/clipboard.min.js"></script>
    <script src="static/assets/axios.min.js"></script>
    <script src="static/assets/index.js" defer></script>
</head>
<body>
<el-main id="app">
    <el-row justify="center">
        <h1 style="margin:0;">{{ $t("title") }}</h1>
        <!-- TODO: 可以手动切换语言
        <el-select v-model="locale" @change="changeLocale">
            <el-option label="English" value="en"></el-option>
            <el-option label="中文" value="zh"></el-option>
        </el-select>
        -->
    </el-row>

    <!-- 项目选择器 -->
    <el-row justify="center" style="margin: 10px 0;">
        <el-select v-model="currentLibrary" @change="handleLibraryChange" style="width: 300px; margin-right: 10px;">
            <el-option label="永久素材库" value="permanent">
                <template #default>
                    <span><i class="el-icon-collection" style="margin-right: 5px;"></i>永久素材库</span>
                </template>
            </el-option>
            <el-option v-for="project in projects" :key="project.id" :label="'项目: ' + project.name" :value="project.id">
                <template #default>
                    <span><i class="el-icon-folder" style="margin-right: 5px;"></i>项目: {{ project.name }}</span>
                </template>
            </el-option>
            <el-option label="+ 新建项目" value="__new__">
                <template #default>
                    <span style="color: #409EFF;"><i class="el-icon-plus" style="margin-right: 5px;"></i>新建项目</span>
                </template>
            </el-option>
        </el-select>
        <el-button @click="showProjectManager = true">项目管理</el-button>
        <el-button v-if="currentLibrary !== 'permanent'" type="primary" @click="showAddMaterialDialog = true">
            <i class="el-icon-upload"></i> 添加素材
        </el-button>
    </el-row>

    <el-row justify="center">
        <el-tag size="large" effect="dark">{{ $t("scanStatus." + (isScanning ? "scanning" : "scanComplete")) }}</el-tag>
        <el-tag size="large" type="success" effect="dark">{{ $t("statusLabels.totalImages") }}: {{ status.total_images }}</el-tag>
        <el-tag size="large" type="success" effect="dark">{{ $t("statusLabels.totalVideos") }}: {{ status.total_videos }}</el-tag>
        <el-tag size="large" type="success" effect="dark">{{ $t("statusLabels.totalVideoFrames") }}: {{ status.total_video_frames }}</el-tag>
        <el-tag size="large" v-if="status.total_pexels_videos != 0" type="success" effect="dark">
            {{ $t("statusLabels.totalPexelsVideos") }}: {{status.total_pexels_videos }}
        </el-tag>
        <el-tag size="large" v-if="isScanning" type="info" effect="dark">
            {{ $t("statusLabels.scanningFiles") }}: {{ status.scanning_files === 0 && status.remain_files === 0 ? $t('statusLabels.calculating') : status.scanning_files }}
        </el-tag>
        <el-tag size="large" v-if="isScanning" type="info" effect="dark">
            {{ $t("statusLabels.remainFiles") }}: {{ status.scanning_files === 0 && status.remain_files === 0 ? $t('statusLabels.calculating') : status.remain_files }}
        </el-tag>
        <el-tag size="large" v-if="isScanning" type="info" effect="dark">{{ $t("statusLabels.remainTime") }}: {{ status.remain_time }}</el-tag>
        <el-tag size="large" v-if="isScanning" type="danger" effect="dark">
            {{ $t("statusLabels.scanProgress") }}: {{ Math.trunc(status.progress * 100) }}%
        </el-tag>
        <el-button-group v-if="!isScanning">
            <el-button round type="primary" size="default" @click="scan">{{ $t("buttons.scan") }}</el-button>
        </el-button-group>
        <!--<el-button-group>-->
        <!--    <el-button round type="warning" size="small" @click="cleanCache">{{ $t("buttons.cleanCache") }}</el-button>-->
        <!--</el-button-group>-->
        <el-button-group v-if="enableLogin">
            <a href="/logout">
                <el-button round type="danger" size="default">{{ $t("buttons.logout") }}</el-button>
            </a>
        </el-button-group>
        <el-progress style="width:100%" v-if="isScanning" :percentage="Math.trunc(status.progress*100)" :stroke-width="10"></el-progress>
    </el-row>

    <el-row>
        <el-tabs type="border-card" v-model="currentTab">

            <el-tab-pane :label="$t('searchTabs.textSearch')" name="0">
                <el-form ref="form" :model="form" :inline="true">
                    <el-row>
                        <el-col :span="18">
                            <el-input :placeholder="$t('formPlaceholders.positiveSearch')" v-model="form.positive" class="input-with-select"
                                  @keyup.enter.native="search(0)"></el-input>
                        </el-col>
                        <el-col :span="6">
                            <el-select v-model="form.top_n" :placeholder="$t('formPlaceholders.topNResults')" style="width:100px">
                                <el-option label="Top 6" value="6"></el-option>
                                <el-option label="Top 12" value="12"></el-option>
                                <el-option label="Top 30" value="30"></el-option>
                                <el-option label="Top 150" value="150"></el-option>
                                <el-option label="Top 600" value="600"></el-option>
                                <el-option :label="$t('formPlaceholders.topnAll')" value="1000000"></el-option>
                            </el-select>
                            <el-button type="success" icon="Search" @click="search(0)">{{ $t('searchButtons.search') }}</el-button>
                            <el-button type="primary" icon="DocumentCopy" @click="copyAllPaths">{{ $t('messages.copyAllPaths') }}</el-button>
                        </el-col>
                    </el-row>
                    <el-collapse v-model="activeCollapse">
                        <el-collapse-item :title="$t('formPlaceholders.advanceSearch')" name="1" icon="CaretRight">
                            <el-input :placeholder="$t('formPlaceholders.negativeSearch')" v-model="form.negative" class="input-with-select"
                              @keyup.enter.native="search(0)"></el-input>
                            <el-input :placeholder="$t('formPlaceholders.path')" v-model="form.path" class="input-with-select"
                                      @keyup.enter.native="search(0)"></el-input>
                            <el-form-item :label="$t('formPlaceholders.positiveThreshold')" style="margin-bottom: 0px;" @keyup.enter.native="search(0)">
                                <el-slider style="width:200px" v-model="form.positive_threshold"></el-slider>
                            </el-form-item>
                            <el-form-item :label="$t('formPlaceholders.negativeThreshold')" style="margin-bottom: 0px;" @keyup.enter.native="search(0)">
                                <el-slider style="width:200px" v-model="form.negative_threshold"></el-slider>
                            </el-form-item>
                            <el-form-item :label="$t('formPlaceholders.date')" style="margin-bottom: 0px;">
                                <el-date-picker v-model="time_filter" type="datetimerange" start-placeholder="Start date" end-placeholder="End date"
                                                format="YYYY-MM-DD HH:mm:ss" date-format="YYYY/MM/DD ddd" time-format="A hh:mm:ss"></el-date-picker>
                            </el-form-item>
                        </el-collapse-item>
                        <!-- 搜索范围选择 -->
                        <el-row style="margin-top: 10px;">
                            <el-col :span="24">
                                <el-divider content-position="left">搜索范围</el-divider>
                                <el-radio-group v-model="searchScope">
                                    <el-radio label="permanent">永久库</el-radio>
                                    <el-radio label="project" v-if="currentLibrary !== 'permanent'">当前项目</el-radio>
                                </el-radio-group>
                            </el-col>
                        </el-row>
                    </el-collapse>
                </el-form>
            </el-tab-pane>

            <el-tab-pane :label="$t('searchTabs.imageSearch')" name="1">
                <el-row>
                    <el-col :span="6" style="display: flex; justify-content: center; padding-right: 10px">
                        <el-image fit="contain" :src="imageSearchUrl"></el-image>
                    </el-col>
                    <el-col :span="18">
                        <el-upload ref="upload" drag action="api/upload" :multiple=false :limit="1" :on-exceed="handleExceed" :on-success="handleSuccess" :before-upload="handleBeforeUpload">
                            <i class="el-icon-upload"></i>
                            <div class="el-upload__text">{{ $t('uploader.drag') }}<em>{{ $t('uploader.click') }}</em></div>
                        </el-upload>
                        <el-form ref="form" :model="form" :inline="true" style="margin-top:5px;">
                            <el-select v-model="form.top_n" :placeholder="$t('formPlaceholders.topNResults')" style="width:100px"
                                       @keyup.enter.native="search(1)">
                                <el-option label="Top 6" value="6"></el-option>
                                <el-option label="Top 12" value="12"></el-option>
                                <el-option label="Top 30" value="30"></el-option>
                                <el-option label="Top 150" value="150"></el-option>
                                <el-option label="Top 600" value="600"></el-option>
                                <el-option :label="$t('formPlaceholders.topnAll')" value="1000000"></el-option>
                            </el-select>
                            <el-button type="success" icon="Search" @click="search(1)">{{ $t('searchButtons.search') }}</el-button>
                            <el-button type="success" icon="Pointer" @click="pasteImg">{{ $t('searchButtons.paste') }}</el-button>
                            <el-button type="primary" icon="DocumentCopy" @click="copyAllPaths">{{ $t('messages.copyAllPaths') }}</el-button>
                            <el-collapse v-model="activeCollapse">
                                <el-collapse-item :title="$t('formPlaceholders.advanceSearch')" name="1" icon="CaretRight">
                                    <el-input :placeholder="$t('formPlaceholders.path')" v-model="form.path" class="input-with-select"
                                              @keyup.enter.native="search(1)"></el-input>
                                    <el-form-item :label="$t('formPlaceholders.positiveThreshold')" style="margin-bottom: 0px;" @keyup.enter.native="search(1)">
                                        <el-slider style="width:200px" v-model="form.image_threshold"></el-slider>
                                    </el-form-item>
                                    <el-form-item :label="$t('formPlaceholders.date')" style="margin-bottom: 0px;">
                                        <el-date-picker v-model="time_filter" type="datetimerange" start-placeholder="Start date" end-placeholder="End date"
                                                        format="YYYY-MM-DD HH:mm:ss" date-format="YYYY/MM/DD ddd" time-format="A hh:mm:ss"></el-date-picker>
                                    </el-form-item>
                                </el-collapse-item>
                            </el-collapse>
                        </el-form>
                    </el-col>
                </el-row>
            </el-tab-pane>

            <el-tab-pane :label="$t('searchTabs.textVideoSearch')" name="2">
                <el-form ref="form" :model="form" :inline="true">
                    <el-row>
                        <el-col :span="18">
                            <el-input :placeholder="$t('formPlaceholders.positiveSearch')" v-model="form.positive" class="input-with-select"
                              @keyup.enter.native="search(2)"></el-input>
                        </el-col>
                        <el-col :span="6">
                            <el-select v-model="form.top_n" :placeholder="$t('formPlaceholders.topNResults')" style="width:100px">
                                <el-option label="Top 6" value="6"></el-option>
                                <el-option label="Top 12" value="12"></el-option>
                                <el-option label="Top 30" value="30"></el-option>
                                <el-option label="Top 150" value="150"></el-option>
                                <el-option label="Top 600" value="600"></el-option>
                                <el-option :label="$t('formPlaceholders.topnAll')" value="1000000"></el-option>
                            </el-select>
                            <el-button type="success" icon="Search" @click="search(2)">{{ $t('searchButtons.search') }}</el-button>
                            <el-button type="primary" icon="DocumentCopy" @click="copyAllPaths">{{ $t('messages.copyAllPaths') }}</el-button>
                        </el-col>
                    </el-row>
                    <el-collapse v-model="activeCollapse">
                        <el-collapse-item :title="$t('formPlaceholders.advanceSearch')" name="1" icon="CaretRight">
                            <el-input :placeholder="$t('formPlaceholders.negativeSearch')" v-model="form.negative" class="input-with-select"
                                      @keyup.enter.native="search(2)"></el-input>
                            <el-input :placeholder="$t('formPlaceholders.path')" v-model="form.path" class="input-with-select"
                                      @keyup.enter.native="search(2)"></el-input>
                            <el-form-item :label="$t('formPlaceholders.positiveThreshold')" style="margin-bottom: 0px;" @keyup.enter.native="search(2)">
                                <el-slider style="width:200px" v-model="form.positive_threshold"></el-slider>
                            </el-form-item>
                            <el-form-item :label="$t('formPlaceholders.negativeThreshold')" style="margin-bottom: 0px;" @keyup.enter.native="search(2)">
                                <el-slider style="width:200px" v-model="form.negative_threshold"></el-slider>
                            </el-form-item>
                            <el-form-item :label="$t('formPlaceholders.date')" style="margin-bottom: 0px;">
                                <el-date-picker v-model="time_filter" type="datetimerange" start-placeholder="Start date" end-placeholder="End date"
                                                format="YYYY-MM-DD HH:mm:ss" date-format="YYYY/MM/DD ddd" time-format="A hh:mm:ss"></el-date-picker>
                            </el-form-item>
                        </el-collapse-item>
                        <!-- 搜索范围选择 -->
                        <el-row style="margin-top: 10px;">
                            <el-col :span="24">
                                <el-divider content-position="left">搜索范围</el-divider>
                                <el-radio-group v-model="searchScope">
                                    <el-radio label="permanent">永久库</el-radio>
                                    <el-radio label="project" v-if="currentLibrary !== 'permanent'">当前项目</el-radio>
                                </el-radio-group>
                            </el-col>
                        </el-row>
                    </el-collapse>
                </el-form>
            </el-tab-pane>

            <el-tab-pane :label="$t('searchTabs.imageVideoSearch')" name="3">
                <el-row>
                    <el-col :span="6" style="display: flex; justify-content: center; padding-right: 10px">
                        <el-image fit="contain" :src="imageSearchUrl"></el-image>
                    </el-col>
                    <el-col :span="18">
                        <el-upload ref="upload" drag action="api/upload" :multiple=false :limit="1" :on-exceed="handleExceed" :on-success="handleSuccess" :before-upload="handleBeforeUpload">
                            <i class="el-icon-upload"></i>
                            <div class="el-upload__text">{{ $t('uploader.drag') }}<em>{{ $t('uploader.click') }}</em></div>
                        </el-upload>
                        <el-form ref="form" :model="form" :inline="true" style="margin-top:5px;">
                            <el-select v-model="form.top_n" :placeholder="$t('formPlaceholders.topNResults')" style="width:100px"
                                       @keyup.enter.native="search(1)">
                                <el-option label="Top 6" value="6"></el-option>
                                <el-option label="Top 12" value="12"></el-option>
                                <el-option label="Top 30" value="30"></el-option>
                                <el-option label="Top 150" value="150"></el-option>
                                <el-option label="Top 600" value="600"></el-option>
                                <el-option :label="$t('formPlaceholders.topnAll')" value="1000000"></el-option>
                            </el-select>
                            <el-button type="success" icon="Search" @click="search(3)">{{ $t('searchButtons.search') }}</el-button>
                            <el-button type="success" icon="Pointer" @click="pasteImg">{{ $t('searchButtons.paste') }}</el-button>
                            <el-button type="primary" icon="DocumentCopy" @click="copyAllPaths">{{ $t('messages.copyAllPaths') }}</el-button>
                            <el-collapse v-model="activeCollapse">
                                <el-collapse-item :title="$t('formPlaceholders.advanceSearch')" name="1" icon="CaretRight">
                                    <el-input :placeholder="$t('formPlaceholders.path')" v-model="form.path" class="input-with-select"
                                              @keyup.enter.native="search(3)"></el-input>
                                    <el-form-item :label="$t('formPlaceholders.positiveThreshold')" style="margin-bottom: 0px;" @keyup.enter.native="search(1)">
                                        <el-slider style="width:200px" v-model="form.image_threshold"></el-slider>
                                    </el-form-item>
                                    <el-form-item :label="$t('formPlaceholders.date')" style="margin-bottom: 0px;">
                                        <el-date-picker v-model="time_filter" type="datetimerange" start-placeholder="Start date" end-placeholder="End date"
                                                        format="YYYY-MM-DD HH:mm:ss" date-format="YYYY/MM/DD ddd" time-format="A hh:mm:ss"></el-date-picker>
                                    </el-form-item>
                                </el-collapse-item>
                            </el-collapse>
                        </el-form>
                    </el-col>
                </el-row>
            </el-tab-pane>

            <el-tab-pane :label="$t('searchTabs.textImageSimilarity')" name="6">
                <el-input :placeholder="$t('formPlaceholders.textMatch')" v-model="form.positive" class="input-with-select"></el-input>
                <el-row>
                    <el-col :span="6" style="display: flex; justify-content: center; padding-right: 10px">
                        <el-image fit="contain" :src="imageSearchUrl"></el-image>
                    </el-col>
                    <el-col :span="18">
                        <el-upload ref="upload" drag action="api/upload" :multiple=false :limit="1" :on-exceed="handleExceed" :on-success="handleSuccess" :before-upload="handleBeforeUpload">
                            <i class="el-icon-upload"></i>
                            <div class="el-upload__text">{{ $t('uploader.drag') }}<em>{{ $t('uploader.click') }}</em></div>
                        </el-upload>
                        <el-row style="margin-top:10px;">
                            <el-button type="success" icon="Search" @click="search(4)">{{ $t('searchButtons.calculateSimilarity') }}</el-button>
                            <el-button type="success" icon="Pointer" @click="pasteImg">{{ $t('searchButtons.paste') }}</el-button>
                            <el-button type="primary" icon="DocumentCopy" @click="copyAllPaths">{{ $t('messages.copyAllPaths') }}</el-button>
                        </el-row>
                    </el-col>
                </el-row>
            </el-tab-pane>

            <el-tab-pane v-if="status.total_pexels_videos != 0" :label="$t('searchTabs.pexelsVideos')" name="7">
                <el-form ref="form" :model="form" :inline="true">
                    <el-input :placeholder="$t('formPlaceholders.positiveSearch')" v-model="form.positive" class="input-with-select"
                              @keyup.enter.native="search(9)"></el-input>
                    <el-form-item :label="$t('formPlaceholders.positiveThreshold')" style="margin-bottom: 0px;" @keyup.enter.native="search(9)">
                        <el-slider style="width:200px" v-model="form.positive_threshold"></el-slider>
                    </el-form-item>
                    <el-select v-model="form.top_n" :placeholder="$t('formPlaceholders.topNResults')" style="width:100px">
                        <el-option label="Top 6" value="6"></el-option>
                        <el-option label="Top 12" value="12"></el-option>
                        <el-option label="Top 30" value="30"></el-option>
                        <el-option label="Top 150" value="150"></el-option>
                        <el-option label="Top 600" value="600"></el-option>
                        <el-option :label="$t('formPlaceholders.topnAll')" value="1000000"></el-option>
                    </el-select>
                    <el-button type="success" icon="Search" @click="search(9)">{{ $t('searchButtons.search') }}</el-button>
                </el-form>
            </el-tab-pane>

        </el-tabs>
    </el-row>

    <!--TODO: 代码优化，播放量显示优化（数字过大的时候看不清位数）-->
    <el-row :gutter="5"
            v-if="form.search_type === 0 || form.search_type === 1 || form.search_type === 2 || form.search_type === 3 || form.search_type === 5 || form.search_type === 6 || form.search_type === 7 || form.search_type === 8">
        <el-col :span="8" v-for="(file, index) in files">
            <el-card style="margin-top: 5px;">
                <el-row>
                    <el-image loading="lazy"
                              v-if="form.search_type === 0 || form.search_type === 1 || form.search_type === 5 || form.search_type === 7"
                              fit="contain" :src="file.url + '&thumbnail=1'" :preview-src-list="image_url_list" :initial-index="index"
                              :hide-on-click-modal="true"></el-image>
                    <video preload="metadata"
                           v-if="form.search_type === 2 || form.search_type === 3 || form.search_type === 6 || form.search_type === 8"
                           :src="file.url" controls></video>
                </el-row>
                <el-row justify="center">
                    <!-- 来源标签 -->
                    <el-tooltip content="来源库" placement="bottom" v-if="file.source">
                        <el-tag size="default" :type="file.source === '永久库' ? 'primary' : 'success'" effect="dark">{{file.source}}</el-tag>
                    </el-tooltip>
                    <el-tooltip :content="$t('fileResults.matchingProbability')" placement="bottom" v-if="file.score">
                        <el-tag size="default" effect="dark">{{(file.score * 100).toFixed(1)}}%</el-tag>
                    </el-tooltip>
                    <el-tooltip :content="file.path" placement="bottom">
                        <el-tag size="default" type="info" effect="dark" class="copy" :data-clipboard-text="file.path">{{file.path.replace(/\\/g, '/').split('/').pop()}}
                        </el-tag>
                    </el-tooltip>
                    <el-tooltip v-if="file.end_time" :content="$t('fileResults.matchingTimeRange')" placement="bottom">
                        <el-tag size="default" type="warning" effect="dark">{{file.start_time}} ~ {{file.end_time}}</el-tag>
                    </el-tooltip>
                    <el-button size="small" round type="success"
                               v-if="form.search_type === 0 || form.search_type === 1 || form.search_type === 5 || form.search_type === 7"
                               @click="searchFromImage(5,file.url)">{{ $t('fileResults.imageSearch') }}
                    </el-button>
                    <el-button size="small" round type="success"
                               v-if="form.search_type === 0 || form.search_type === 1 || form.search_type === 5 || form.search_type === 7"
                               @click="searchFromImage(6,file.url)">{{ $t('fileResults.imageVideoSearch') }}
                    </el-button>
                    <el-button size="small" round type="success" v-if="form.search_type === 2 || form.search_type === 3 || form.search_type === 6"
                               @click="downloadVideoClip(file.url,file.start_time,file.end_time)">{{ $t('fileResults.downloadVideoClip') }}
                    </el-button>
                </el-row>
            </el-card>
        </el-col>
    </el-row>

    <el-row :gutter="5" v-if="form.search_type === 9">
        <el-row :gutter="5">
            <el-col :span="8" v-for="video in pexels_videos">
                <el-card style="margin-top: 5px;">
                    <el-row style="text-align: center"><strong>{{video.title}}</strong></el-row>
                    <video preload="none" :src="video.content_loc" :poster="video.thumbnail_loc + '?fm=webp&fit=corp&min-w=640&h=480'"
                           controls></video>
                    <el-row>
                        <el-tooltip :content="$t('fileResults.matchingProbability')" placement="bottom" v-if="video.score">
                            <el-tag size="small" effect="dark">{{(video.score * 100).toFixed(1)}}%
                            </el-tag>
                        </el-tooltip>
                        <el-tag size="small" type="success" effect="dark">{{ $t('pexelsResults.viewCount') }}: {{video.view_count}}</el-tag>
                        <el-link :href="'https://www.pexels.com/video/' + video.thumbnail_loc.split('/')[4]" type="info" target="_blank">
                            {{ $t('pexelsResults.sourcePage') }}
                        </el-link>
                    </el-row>
                    <el-row>{{video.description}}</el-row>
                </el-card>
            </el-col>
        </el-row>
    </el-row>

    <!-- 新建项目对话框 -->
    <el-dialog v-model="createProjectDialogVisible" title="新建项目" width="500px">
        <el-form :model="newProject" :rules="projectRules" ref="projectForm" label-width="100px">
            <el-form-item label="项目名称" prop="name" required>
                <el-input v-model="newProject.name" placeholder="请输入项目名称"></el-input>
            </el-form-item>
            <el-form-item label="客户名称">
                <el-input v-model="newProject.client_name" placeholder="可选"></el-input>
            </el-form-item>
            <el-form-item label="项目描述">
                <el-input v-model="newProject.description" type="textarea" :rows="3" placeholder="可选"></el-input>
            </el-form-item>
        </el-form>
        <template #footer>
            <el-button @click="createProjectDialogVisible = false">取消</el-button>
            <el-button type="primary" @click="createProject" :loading="creatingProject">创建</el-button>
        </template>
    </el-dialog>

    <el-dialog v-model="duplicateDialogVisible" title="检测到重复文件" width="600px" :close-on-click-modal="false">
        <div v-if="pendingDuplicate">
            <div class="duplicate-block">
                <h4>新文件</h4>
                <p class="duplicate-path">{{ pendingDuplicate.new_file?.path }}</p>
                <div class="duplicate-preview">
                    <img :src="pendingDuplicate.new_file?.thumbnail" alt="new" v-if="pendingDuplicate.new_file?.thumbnail">
                    <span v-else class="thumb-placeholder"><i class="el-icon-picture-outline"></i></span>
                    <div>
                        <div>名称：{{ pendingDuplicate.new_file?.filename }}</div>
                        <div>大小：{{ formatFileSize(pendingDuplicate.new_file?.size || 0) }}</div>
                    </div>
                </div>
            </div>
            <div class="duplicate-block">
                <h4>已有文件</h4>
                <p class="duplicate-path">{{ pendingDuplicate.existing_file?.path }}</p>
                <div class="duplicate-preview">
                    <img :src="pendingDuplicate.existing_file?.thumbnail" alt="existing" v-if="pendingDuplicate.existing_file?.thumbnail">
                    <span v-else class="thumb-placeholder"><i class="el-icon-picture-outline"></i></span>
                    <div>
                        <div>名称：{{ pendingDuplicate.existing_file?.filename }}</div>
                        <div>大小：{{ formatFileSize(pendingDuplicate.existing_file?.size || 0) }}</div>
                    </div>
                </div>
            </div>
        </div>
        <template #footer>
            <el-checkbox v-model="duplicateRememberChoice">应用到本次剩余文件</el-checkbox>
            <span class="dialog-spacer"></span>
            <el-button @click="submitDuplicateDecision('skip')" :loading="duplicateDecisionLoading">跳过</el-button>
            <el-button type="danger" @click="submitDuplicateDecision('overwrite')" :loading="duplicateDecisionLoading">覆盖</el-button>
        </template>
    </el-dialog>

    <!-- 项目管理对话框 -->
    <el-dialog v-model="showProjectManager" title="项目管理" width="800px">
        <el-table :data="projects" style="width: 100%" v-loading="loadingProjects">
            <el-table-column prop="name" label="项目名称" width="180"></el-table-column>
            <el-table-column prop="client_name" label="客户" width="150"></el-table-column>
            <el-table-column label="状态" width="100">
                <template #default="{ row }">
                    <el-tag :type="row.status === 'active' ? 'success' : 'info'">
                        {{ row.status === 'active' ? '进行中' : '已完成' }}
                    </el-tag>
                </template>
            </el-table-column>
            <el-table-column label="素材数量" width="120">
                <template #default="{ row }">
                    <el-tag type="info">{{ row.stats?.image_count || 0 }} 张图</el-tag>
                </template>
            </el-table-column>
            <el-table-column label="操作" width="150">
                <template #default="{ row }">
                    <el-button size="small" @click="switchToProject(row.id)">切换</el-button>
                    <el-popconfirm
                        title="确定要删除这个项目吗？"
                        @confirm="deleteProject(row.id)">
                        <template #reference>
                            <el-button size="small" type="danger">删除</el-button>
                        </template>
                    </el-popconfirm>
                </template>
            </el-table-column>
        </el-table>
    </el-dialog>

    <!-- 扫描对话框（项目库专用） -->
    <el-dialog v-model="scanDialogVisible" title="扫描到项目" width="600px">
        <el-alert title="项目库扫描需要指定路径，支持多个路径" type="info" :closable="false" style="margin-bottom: 15px;"></el-alert>
        <el-form label-width="80px">
            <el-form-item label="目标项目">
                <el-tag type="success">{{ currentLibrary === 'permanent' ? '永久库' : projects.find(p => p.id === currentLibrary)?.name || '未知项目' }}</el-tag>
            </el-form-item>
            <el-form-item label="扫描路径" required>
                <el-input v-model="newScanPath" placeholder="输入文件夹路径，例如: F:/项目/output" style="margin-bottom: 10px;">
                    <template #append>
                        <el-button @click="addScanPath" type="primary">添加</el-button>
                    </template>
                </el-input>
                <el-table :data="scanPaths" style="width: 100%;" height="200" v-if="scanPaths.length > 0">
                    <el-table-column prop="path" label="路径列表">
                        <template #default="{ row, $index }">
                            <span style="font-size: 12px;">{{ row }}</span>
                            <el-button size="small" type="text" style="float: right; color: #f56c6c;" @click="removeScanPath($index)">删除</el-button>
                        </template>
                    </el-table-column>
                </el-table>
                <el-empty description="暂无路径" :image-size="60" v-else></el-empty>
                <el-button size="small" @click="clearScanPaths" v-if="scanPaths.length > 0" style="margin-top: 10px;" type="info">清空所有</el-button>
            </el-form-item>
        </el-form>
        <template #footer>
            <el-button @click="scanDialogVisible = false">取消</el-button>
            <el-button type="primary" @click="startScanFromDialog" :disabled="scanPaths.length === 0" :loading="isScanning">开始扫描</el-button>
        </template>
    </el-dialog>

    <!-- 添加素材对话框 -->
    <el-dialog v-model="showAddMaterialDialog" :title="'为项目添加素材：' + (projects.find(p => p.id === currentLibrary)?.name || '')" width="90%" top="5vh">
        <el-steps :active="addMaterialStep" align-center style="margin-bottom: 20px;">
            <el-step title="输入路径" description="粘贴文件/文件夹路径"></el-step>
            <el-step title="预览文件" description="查看并筛选文件"></el-step>
            <el-step title="索引中" description="正在处理文件"></el-step>
            <el-step title="完成" description="查看索引结果"></el-step>
        </el-steps>

        <!-- 步骤1: 路径输入 -->
        <div v-show="addMaterialStep === 0">
            <el-alert title="使用说明：在资源管理器中选择文件/文件夹,按 Shift+右键 → 复制为路径,然后粘贴到下方" type="info" :closable="false" style="margin-bottom: 15px;"></el-alert>
            <el-input
                type="textarea"
                v-model="materialPathInput"
                placeholder="粘贴文件或文件夹路径(支持多行)"
                :rows="6"
                @paste="handlePathPaste">
            </el-input>
            <div class="add-material-actions">
                <div>
                    <el-button @click="handlePreviewFiles" type="primary" :loading="loadingPreview">
                        <i class="el-icon-view"></i> 预览文件
                    </el-button>
                    <el-button @click="materialPathInput = ''">清空</el-button>
                </div>
                <el-dropdown v-if="historyPaths.length" trigger="click" @command="applyHistoryPath">
                    <span class="el-dropdown-link">
                        历史路径<i class="el-icon-arrow-down el-icon--right"></i>
                    </span>
                    <template #dropdown>
                        <el-dropdown-menu class="history-dropdown">
                            <el-dropdown-item v-for="item in historyPaths" :key="item.path" :command="item.path">
                                <div class="history-entry">
                                    <span class="history-path">{{ item.path }}</span>
                                    <span class="history-time">{{ item.timeLabel }}</span>
                                </div>
                            </el-dropdown-item>
                        </el-dropdown-menu>
                    </template>
                </el-dropdown>
            </div>
        </div>

        <!-- 步骤2: 文件预览列表 -->
        <div v-show="addMaterialStep === 1">
            <div style="margin-bottom: 10px;">
                <el-button-group>
                    <el-button size="small" @click="selectAllFiles">全选</el-button>
                    <el-button size="small" @click="invertSelection">反选</el-button>
                    <el-button size="small" @click="filterImageOnly">仅图片</el-button>
                    <el-button size="small" @click="filterVideoOnly">仅视频</el-button>
                    <el-button size="small" @click="showAllFiles">显示全部</el-button>
                </el-button-group>
                <span style="margin-left: 20px; color: #606266;">
                    已选择 <strong>{{ selectedFilesCount }}</strong> 个文件，
                    总大小 <strong>{{ formatFileSize(selectedFilesSize) }}</strong>
                </span>
            </div>

                <el-table
                ref="fileTable"
                :data="filteredFiles"
                style="width: 100%"
                height="400"
                @selection-change="handleSelectionChange">
                <el-table-column type="selection" width="55"></el-table-column>
                <el-table-column label="类型" width="60">
                    <template #default="{ row }">
                        <i :class="row.type === 'image' ? 'el-icon-picture' : 'el-icon-video-camera'"
                           :style="{ color: row.type === 'image' ? '#409EFF' : '#67C23A', fontSize: '20px' }"></i>
                    </template>
                </el-table-column>
                <el-table-column label="缩略图" width="80">
                    <template #default="{ row }">
                        <img v-if="row.thumbnailUrl" :src="row.thumbnailUrl" style="width: 60px; height: 60px; object-fit: cover;">
                        <div v-else style="width: 60px; height: 60px; background: #f5f7fa; display: flex; align-items: center; justify-content: center;">
                            <i class="el-icon-picture-outline" style="font-size: 20px; color: #909399;"></i>
                        </div>
                    </template>
                </el-table-column>
                <el-table-column label="文件名" min-width="200">
                    <template #default="{ row }">
                        <span :style="{ color: row.is_indexed ? '#C0C4CC' : '#303133' }">{{ row.filename }}</span>
                        <el-tag v-if="row.is_indexed" size="small" type="info" style="margin-left: 5px;">已索引</el-tag>
                    </template>
                </el-table-column>
                <el-table-column label="大小" width="100">
                    <template #default="{ row }">
                        {{ formatFileSize(row.size) }}
                    </template>
                </el-table-column>
                <el-table-column label="路径" min-width="250" show-overflow-tooltip>
                    <template #default="{ row }">
                        <span style="font-size: 12px; color: #909399;">{{ row.path }}</span>
                    </template>
                </el-table-column>
            </el-table>

            <div style="margin-top: 15px;">
                <el-button @click="addMaterialStep = 0">上一步</el-button>
                <el-button type="primary" @click="startBatchIndex" :disabled="selectedFiles.length === 0">
                    开始索引 ({{ selectedFiles.length }} 个文件)
                </el-button>
            </div>
        </div>

        <!-- 步骤3: 索引进度 -->
        <div v-show="addMaterialStep === 2">
            <div style="text-align: center; padding: 40px 20px;">
                <el-progress
                    type="circle"
                    :percentage="indexProgress"
                    :width="150"
                    :status="indexStatus === 'success' ? 'success' : (indexStatus === 'failed' ? 'exception' : undefined)">
                </el-progress>
                <div style="margin-top: 20px; font-size: 16px; color: #606266;">
                    正在索引: <strong>{{ currentIndexingFile }}</strong>
                </div>
                <div style="margin-top: 10px; color: #909399;">
                    进度: {{ indexTaskInfo.processed || 0 }} / {{ indexTaskInfo.total || 0 }}
                </div>
                <div v-if="indexTaskInfo.remain_time" style="margin-top: 5px; color: #909399;">
                    预计剩余时间: {{ formatTime(indexTaskInfo.remain_time) }}
                </div>
                <div style="margin-top: 30px;">
                    <el-button type="danger" @click="cancelBatchIndex" :loading="cancelling">取消索引</el-button>
                </div>
            </div>
        </div>

        <!-- 步骤4: 完成报告 -->
        <div v-show="addMaterialStep === 3">
            <el-result
                :icon="indexTaskInfo.failed?.length > 0 ? 'warning' : 'success'"
                :title="indexTaskInfo.failed?.length > 0 ? '索引完成(部分失败)' : '索引完成'"
                :sub-title="'成功: ' + (indexTaskInfo.success || 0) + ' 个 | 失败: ' + (indexTaskInfo.failed?.length || 0) + ' 个 | 重复: ' + (indexTaskInfo.duplicates?.length || 0) + ' 个'">
                <template #extra>
                    <el-button type="primary" @click="closeAddMaterialDialog">关闭</el-button>
                    <el-button @click="showIndexDetails = !showIndexDetails">
                        {{ showIndexDetails ? '隐藏' : '查看' }}详情
                    </el-button>
                </template>
            </el-result>

            <div v-if="showIndexDetails" style="margin-top: 20px;">
                <el-collapse v-model="activeCollapseNames">
                    <el-collapse-item title="失败文件" name="failed" v-if="indexTaskInfo.failed?.length > 0">
                        <el-table :data="indexTaskInfo.failed" style="width: 100%">
                            <el-table-column prop="path" label="文件路径" show-overflow-tooltip></el-table-column>
                            <el-table-column prop="error" label="错误原因" width="200"></el-table-column>
                        </el-table>
                    </el-collapse-item>
                    <el-collapse-item title="重复文件" name="duplicates" v-if="indexTaskInfo.duplicates?.length > 0">
                        <el-table :data="indexTaskInfo.duplicates" style="width: 100%">
                            <el-table-column prop="path" label="新文件路径" show-overflow-tooltip></el-table-column>
                            <el-table-column prop="existing_path" label="已存在路径" show-overflow-tooltip></el-table-column>
                            <el-table-column prop="action" label="处理方式" width="100"></el-table-column>
                        </el-table>
                    </el-collapse-item>
                </el-collapse>
            </div>
        </div>
    </el-dialog>

    <el-footer style="text-align: center; color: gray; padding: 10px 0; font-size: 14px;">
        <span style="vertical-align: middle;">{{ $t('footer.description1') }}</span>
        <el-link style="vertical-align: middle;" href="https://github.com/chn-lee-yumi/MaterialSearch/" type="info" target="_blank">
            https://github.com/chn-lee-yumi/MaterialSearch/
        </el-link>
        <span style="vertical-align: middle;">{{ $t('footer.description2') }}</span>
    </el-footer>
</el-main>
</body>
<script>
const app = Vue.createApp({
    data() {
        return {
            currentTab: "0",
            isScanning: false,
            status: {
                total_images: 0,
                total_pexels_videos: 0,
                total_video_frames: 0,
                total_videos: 0,
            },
            enableLogin: null,
            form: {
                positive: '',
                negative: '',
                top_n: '6',
                search_type: 0,
                positive_threshold: 20,
                negative_threshold: 30,
                image_threshold: 75,
                img_id: -1,
                path: '',
                start_time: 0,
                end_time: 0,
                library_type: 'permanent',
                project_id: null
            },
            time_filter: null,
            files: [],
            image_url_list: [],
            pexels_videos: [],
            timer: null,
            imageSearchUrl: null,
            activeCollapse: [],
            currentLibrary: localStorage.getItem('currentLibrary') || 'permanent',
            projects: [],
            createProjectDialogVisible: false,
            creatingProject: false,
            newProject: {
                name: '',
                client_name: '',
                description: ''
            },
            projectRules: {
                name: [{required: true, message: '请输入项目名称', trigger: 'blur'}]
            },
            showProjectManager: false,
            loadingProjects: false,
            searchScope: 'permanent',
            scanDialogVisible: false,
            scanTarget: 'permanent',
            scanPaths: [],
            newScanPath: '',
            // 添加素材对话框相关
            showAddMaterialDialog: false,
            addMaterialStep: 0,
            materialPathInput: '',
            previewFiles: [],
            selectedFiles: [],
            loadingPreview: false,
            fileFilter: 'all',
            indexTaskId: null,
            indexTaskInfo: {},
            indexProgress: 0,
            indexStatus: '',
            currentIndexingFile: '',
            indexingInterval: null,
            cancelling: false,
            showIndexDetails: false,
            activeCollapseNames: [],
            historyPaths: [],
            historyStoreKey: 'materialPathHistory',
            thumbnailQueue: [],
            thumbnailTimer: null,
            thumbnailScrollHandler: null,
            duplicateDialogVisible: false,
            pendingDuplicate: null,
            duplicateDecisionLoading: false,
            duplicateRememberChoice: false
        }
    },
    computed: {
        selectedFilesCount() {
            return this.selectedFiles.length;
        },
        selectedFilesSize() {
            return this.selectedFiles.reduce((sum, file) => sum + file.size, 0);
        },
        filteredFiles() {
            if (this.fileFilter === 'all') {
                return this.previewFiles;
            } else if (this.fileFilter === 'image') {
                return this.previewFiles.filter(f => f.type === 'image');
            } else if (this.fileFilter === 'video') {
                return this.previewFiles.filter(f => f.type === 'video');
            }
            return this.previewFiles;
        }
    },
    watch: {
        'currentTab'(val) { localStorage.setItem('currentTab', val); },
        'form.top_n'(val) { localStorage.setItem('form.top_n', val); },
        'form.positive_threshold'(val) { localStorage.setItem('form.positive_threshold', val); },
        'form.negative_threshold'(val) { localStorage.setItem('form.negative_threshold', val); },
        'form.image_threshold'(val) { localStorage.setItem('form.image_threshold', val); },
        'currentLibrary'(val) {
            localStorage.setItem('currentLibrary', val);
            this.refreshRecentPaths();
        },
    },
    mounted: function() {
        fetchServerTimeAndSetOffset();  // 页面加载时获取服务器时间
        this.loadData();
        this.loadProjects();
        this.timer = setInterval(this.loadData, 5000);
        // 加载保存的表单设置
        this.currentTab = localStorage.getItem('currentTab') || '0';
        this.currentLibrary = localStorage.getItem('currentLibrary') || 'permanent';
        this.refreshRecentPaths();
        const keys = ['form.top_n', 'form.positive_threshold',  'form.negative_threshold', 'form.image_threshold'];
        keys.forEach(k => {
            const val = localStorage.getItem(k);
            if (val !== null) {
                const field = k.split('.')[1];
                this.form[field] = field.includes('threshold') ? Number(val) : val;
            }
        });
        // 添加全局粘贴事件监听，实现 Ctrl+V 粘贴图片
        window.addEventListener('paste', async (event) => {
            console.log(event)
            if (!["1", "3"].includes(this.currentTab)) return; // 6不做自动粘贴，因为会覆盖文本框粘贴功能
            await this.pasteImg();
        });
    },
    created() {
        var that = this
        let clipboard = new ClipboardJS(".copy");
        clipboard.on("success", function(e) {
            ElementPlus.ElMessage.success(that.$t('messages.clipboardCopySuccess'));
            e.clearSelection();
        })
    },
    methods: {
        changeLocale(locale) {
            this.$i18n.locale = locale
        },
        cleanCache() {
            var that = this;
            axios.get('api/clean_cache')
                .then(function(response) {
                    ElementPlus.ElMessage.info(response.data);
                })
                .catch(function(error) {
                    console.log(error);
                    ElementPlus.ElMessage.error(error.response.data);
                })
        },
        downloadVideoClip(url, start_time, end_time) {
            var parts = url.split('/');
            var lastPart = parts[parts.length - 1];
            var hashPart = lastPart.split('#')[0];
            window.open(`/api/download_video_clip/${hashPart}/${start_time}/${end_time}`, "_blank");
        },
        loadHistoryStore() {
            try {
                return JSON.parse(localStorage.getItem(this.historyStoreKey) || '[]');
            } catch (e) {
                console.warn('无法解析历史路径', e);
                return [];
            }
        },
        saveHistoryStore(store) {
            localStorage.setItem(this.historyStoreKey, JSON.stringify(store));
        },
        refreshRecentPaths() {
            const store = this.loadHistoryStore();
            const entry = store.find(item => item.project === this.currentLibrary);
            const paths = entry ? entry.paths : [];
            this.historyPaths = paths.map(item => ({
                path: item.path,
                updatedAt: item.updatedAt,
                timeLabel: this.formatHistoryTime(item.updatedAt)
            }));
        },
        persistRecentPaths(paths) {
            if (!paths || paths.length === 0) return;
            const store = this.loadHistoryStore();
            const project = this.currentLibrary;
            let entry = store.find(item => item.project === project);
            if (!entry) {
                entry = { project, paths: [] };
                store.push(entry);
            }
            const now = Date.now();
            paths.forEach(p => {
                const normalized = p.trim();
                if (!normalized) return;
                entry.paths = entry.paths.filter(item => item.path !== normalized);
                entry.paths.unshift({ path: normalized, updatedAt: now });
            });
            entry.paths = entry.paths.slice(0, 10);
            this.saveHistoryStore(store);
            this.refreshRecentPaths();
        },
        applyHistoryPath(path) {
            if (!path) return;
            var lines = this.materialPathInput ? this.materialPathInput.split('\n').map(line => line.trim()).filter(Boolean) : [];
            if (!lines.includes(path)) {
                lines.push(path);
            }
            this.materialPathInput = lines.join('\n');
        },
        formatHistoryTime(timestamp) {
            if (!timestamp) return '';
            var date = new Date(timestamp);
            var mm = (date.getMonth() + 1).toString().padStart(2, '0');
            var dd = date.getDate().toString().padStart(2, '0');
            var hh = date.getHours().toString().padStart(2, '0');
            var mi = date.getMinutes().toString().padStart(2, '0');
            return `${mm}-${dd} ${hh}:${mi}`;
        },
        loadData() {
            var that = this;
            axios.get('api/status')
                .then(function(response) {
                    console.log(response);
                    that.status = response["data"];
                    that.status.remain_time = formatTime(that.status.remain_time);
                    that.isScanning = response["data"]["status"];
                    that.enableLogin = response["data"]["enable_login"];
                })
                .catch(function(error) {
                    console.log(error);
                    ElementPlus.ElMessage.error(error);
                })
        },
        scan() {
            var that = this;

            // 如果是项目库，显示路径输入对话框
            if (that.currentLibrary !== 'permanent') {
                that.scanDialogVisible = true;
                that.scanTarget = that.currentLibrary;
                return;
            }

            // 永久库保持简单确认
            ElementPlus.ElMessageBox.confirm('请选择扫描目标', '扫描确认', {
                confirmButtonText: '扫描到永久库',
                cancelButtonText: '取消',
                type: 'info',
                showCancelButton: true
            }).then(() => {
                axios.get('api/scan?target=permanent')
                    .then(function(response) {
                        console.log(response);
                        that.loadData();
                        ElementPlus.ElMessage.success('已开始扫描到永久库');
                    })
                    .catch(function(error) {
                        console.log(error);
                        ElementPlus.ElMessage.error(error.response.data);
                    });
            });
        },
        startScanFromDialog() {
            var that = this;

            if (that.scanPaths.length === 0) {
                ElementPlus.ElMessage.warning('请至少添加一个扫描路径');
                return;
            }

            // 构建请求URL
            var url = `api/scan?target=${that.scanTarget}`;
            that.scanPaths.forEach(function(path) {
                url += `&path=${encodeURIComponent(path)}`;
            });

            axios.get(url)
                .then(function(response) {
                    console.log(response);
                    that.loadData();
                    that.scanDialogVisible = false;
                    ElementPlus.ElMessage.success(response.data.message);
                })
                .catch(function(error) {
                    console.log(error);
                    ElementPlus.ElMessage.error(error.response.data);
                });
        },
        search(search_type) {
            var that = this;
            var loadingInstance;
            if (search_type === 4) {
                loadingInstance = ElementPlus.ElLoading.service({ fullscreen: true, text: that.$t('messages.matching') });
            } else {
                loadingInstance = ElementPlus.ElLoading.service({ fullscreen: true, text: that.$t('messages.searching') });
            }
            this.upload.clearFiles();
            that.form.search_type = search_type;
            if ((search_type === 0 || search_type === 2) && that.form.positive == "" && that.form.path == "") {
                ElementPlus.ElMessage.error(that.$t('messages.searchContentEmpty'));
                loadingInstance.close();
                return;
            }
            if ((search_type === 4 || search_type == 9) && that.form.positive == "") {
                ElementPlus.ElMessage.error(that.$t('messages.textContentEmpty'));
                loadingInstance.close();
                return;
            }
            if (that.time_filter) {
                that.form.start_time = Math.floor(that.time_filter[0] / 1000);
                that.form.end_time = Math.floor(that.time_filter[1] / 1000);
            } else {
                that.form.start_time = null;
                that.form.end_time = null;
            }

            // 设置搜索范围
            that.form.library_type = that.searchScope;
            that.form.project_id = (that.searchScope === 'project') ? that.currentLibrary : null;

            axios.post('/api/match', that.form)
                .then(function(response) {
                    console.log(response);
                    loadingInstance.close();
                    if (search_type === 0 || search_type === 1 || search_type === 5) {
                        that.files = response["data"];
                        that.image_url_list = [];
                        that.files.forEach(function(element) {
                            that.image_url_list.push(element.url);
                        });
                        ElementPlus.ElMessage.info(that.$t('messages.totalSearchResult') + that.files.length + that.$t('messages.photos'));
                        return;
                    }
                    if (search_type === 2 || search_type === 3 || search_type === 6) {
                        that.files = response["data"];
                        ElementPlus.ElMessage.info(that.$t('messages.totalSearchResult') + that.files.length + that.$t('messages.videos'));
                        return;
                    }
                    if (search_type === 9) {
                        that.pexels_videos = response["data"];
                        return;
                    }
                    if (search_type === 4) {
                        ElementPlus.ElMessage.info(that.$t('messages.matchingSimilarityInfo') + response["data"]["score"] + "%");
                        return;
                    }
                })
                .catch(function(error) {
                    console.log(error);
                    loadingInstance.close();
                    ElementPlus.ElMessage.error(error.response.data);
                })
        },
        searchFromImage(search_type, img_url) {
            console.log(this.currentTab);
            if (search_type === 5) {
                this.currentTab = "1";
            } else if (search_type === 6) {
                this.currentTab = "3";
            }
            this.form.search_type = search_type;
            this.form.positive = '';
            this.form.negative = '';
            var id_str = img_url.match(/(\d+)$/);
            if (id_str) {
                var id_num = parseInt(id_str[1], 10);
                this.form.img_id = id_num;
                this.search(search_type);
            } else {
                ElementPlus.ElMessage.error(that.$t('messages.imgIdNotFound'));
            }
        },
        handleBeforeUpload(file) {
            console.log(file);
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.imageSearchUrl = e.target.result;
                    resolve(true);
                };
                reader.readAsDataURL(file);
            });
        },
        async pasteImg() {
            // 检查浏览器是否支持剪切板 API 和 Image 对象
            if (navigator.clipboard && window.Image) {
                try {
                    // 读取剪切板中的内容，返回一个 Promise，解析为一个 ClipboardItem 数组
                    const clipboardItems = await navigator.clipboard.read();
                    // 检查剪切板中是否有内容，并且第一个项目是否包含图片类型（PNG 或 JPEG）
                    if (clipboardItems.length > 0 && (clipboardItems[0].types.includes('image/png') || clipboardItems[0].types.includes('image/jpeg'))) {
                        // 获取剪切板中的第一个图片项目
                        const [imageItem] = clipboardItems;
                        // 获取图片的 Blob 数据
                        const blob = await imageItem.getType('image/png');
                        // 将 Blob 对象转换为 File 对象
                        const file = this.blobToFile(blob, 'pasteboard.png');
                        // 清空当前文件列表
                        this.upload.clearFiles();
                        // 开始处理文件
                        this.upload.handleStart(file);
                        // 提交文件上传请求
                        this.upload.submit();
                    } else {
                        ElementPlus.ElMessage.error(this.$t('剪切板没有图片'));
                    }
                } catch (error) {
                    // 捕获并处理可能的错误
                    console.error('读取剪切板失败:', error);
                    ElementPlus.ElMessage.error(this.$t('messages.clipboardReadFailed'));
                }
            } else {
                ElementPlus.ElMessage.error(this.$t('messages.clipboardNotSupported'));
            }
        },
        blobToFile(blob, fileName) {
            return new File([blob], fileName, { type: blob.type });
        },
        copyAllPaths() {
            if (!this.files || this.files.length === 0) {
                ElementPlus.ElMessage.warning(this.$t('messages.noFilesToCopy'));
                return;
            }
            const allPaths = this.files.map(f => f.path).join('\n');
            if (window.Clipboard && window.Clipboard.copy) {
                window.Clipboard.copy(allPaths);
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(allPaths).then(() => {
                    ElementPlus.ElMessage.success(this.$t('messages.clipboardCopySuccess'));
                }, () => {
                    ElementPlus.ElMessage.error(this.$t('messages.clipboardReadFailed'));
                });
            } else {
                // fallback
                const textarea = document.createElement('textarea');
                textarea.value = allPaths;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand('copy');
                    ElementPlus.ElMessage.success(this.$t('messages.clipboardCopySuccess'));
                } catch (err) {
                    ElementPlus.ElMessage.error(this.$t('messages.clipboardReadFailed'));
                }
                document.body.removeChild(textarea);
            }
        },
        handleLibraryChange(value) {
            if (value === '__new__') {
                this.createProjectDialogVisible = true;
                this.$nextTick(() => {
                    this.currentLibrary = this.currentLibrary || 'permanent';
                });
            } else {
                this.currentLibrary = value;
                // 自动更新搜索范围：永久库时为permanent，项目库时为project
                if (this.currentLibrary === 'permanent') {
                    this.searchScope = 'permanent';
                } else {
                    this.searchScope = 'project';
                }
                ElementPlus.ElMessage.success(`已切换到 ${value === 'permanent' ? '永久素材库' : '项目'}`);
            }
        },
        async loadProjects() {
            var that = this;
            try {
                const response = await axios.get('/api/projects');
                that.projects = response.data.data || [];
            } catch (error) {
                console.error('加载项目列表失败:', error);
                ElementPlus.ElMessage.error('加载项目列表失败');
            }
        },
        async createProject() {
            var that = this;
            await that.$refs.projectForm.validate(async(valid) => {
                if (valid) {
                    that.creatingProject = true;
                    try {
                        const response = await axios.post('/api/projects', {
                            name: that.newProject.name,
                            client_name: that.newProject.client_name,
                            description: that.newProject.description,
                            status: 'active'
                        });
                        ElementPlus.ElMessage.success('项目创建成功');
                        that.createProjectDialogVisible = false;
                        that.newProject = {name: '', client_name: '', description: ''};
                        await that.loadProjects();
                        that.currentLibrary = response.data.id;
                    } catch (error) {
                        console.error('创建项目失败:', error);
                        ElementPlus.ElMessage.error(error.response?.data?.error || '创建项目失败');
                    } finally {
                        that.creatingProject = false;
                    }
                }
            });
        },
        switchToProject(projectId) {
            this.currentLibrary = projectId;
            this.showProjectManager = false;
            ElementPlus.ElMessage.success('已切换到项目');
        },
        async deleteProject(projectId) {
            var that = this;
            try {
                await axios.delete(`/api/projects/${projectId}`);
                ElementPlus.ElMessage.success('项目已删除');
                await that.loadProjects();
                if (that.currentLibrary === projectId) {
                    that.currentLibrary = 'permanent';
                    if (that.searchScope === 'project') {
                        that.searchScope = 'permanent';
                    }
                }
            } catch (error) {
                console.error('删除项目失败:', error);
                ElementPlus.ElMessage.error(error.response?.data?.error || '删除项目失败');
            }
        },
        addScanPath() {
            var that = this;
            var path = that.newScanPath.trim();
            if (!path) {
                ElementPlus.ElMessage.warning('请输入有效路径');
                return;
            }
            if (that.scanPaths.includes(path)) {
                ElementPlus.ElMessage.warning('路径已存在');
                return;
            }
            that.scanPaths.push(path);
            that.newScanPath = '';
            ElementPlus.ElMessage.success('路径已添加');
        },
        removeScanPath(index) {
            this.scanPaths.splice(index, 1);
            ElementPlus.ElMessage.info('路径已删除');
        },
        clearScanPaths() {
            this.scanPaths = [];
            ElementPlus.ElMessage.info('已清空所有路径');
        },
        // ========== 添加素材对话框方法 ==========
        handlePathPaste(event) {
            // 粘贴事件处理 - 自动解析路径
            setTimeout(() => {
                var input = this.materialPathInput;
                // 去除引号并按行分割
                var lines = input.split('\n').map(line => line.trim().replace(/^["']|["']$/g, '')).filter(line => line);
                this.materialPathInput = lines.join('\n');
            }, 10);
        },
                async handlePreviewFiles() {
            var that = this;
            var input = that.materialPathInput.trim();
            if (!input) {
                ElementPlus.ElMessage.warning('请输入文件或文件夹路径');
                return;
            }

            that.loadingPreview = true;
            var paths = input.split('\n').map(line => line.trim()).filter(line => line);
            that.detachThumbnailHelpers();

            try {
                const response = await axios.post('/api/preview_files', {
                    paths: paths,
                    target: that.currentLibrary
                });
                that.persistRecentPaths(paths);
                that.previewFiles = (response.data || []).map(item => ({
                    ...item,
                    thumbnailUrl: item.thumbnailUrl || null
                }));
                that.selectedFiles = that.previewFiles.filter(f => !f.is_indexed);
                that.fileFilter = 'all';
                that.addMaterialStep = 1;
                ElementPlus.ElMessage.success(`已扫描到 ${response.data.length} 个文件`);

                that.$nextTick(() => {
                    that.$refs.fileTable?.clearSelection();
                    that.previewFiles.forEach(row => {
                        that.$refs.fileTable?.toggleRowSelection(row, !row.is_indexed);
                    });
                    that.initThumbnailLoader();
                });
            } catch (error) {
                console.error('预览文件失败:', error);
                ElementPlus.ElMessage.error(error.response?.data?.error || '预览文件失败');
            } finally {
                that.loadingPreview = false;
            }
        },        selectAllFiles() {
            this.$refs.fileTable?.clearSelection();
            this.filteredFiles.forEach(row => {
                this.$refs.fileTable?.toggleRowSelection(row, true);
            });
        },
        invertSelection() {
            var currentSelected = new Set(this.selectedFiles.map(f => f.path));
            this.filteredFiles.forEach(row => {
                var shouldSelect = !currentSelected.has(row.path);
                this.$refs.fileTable?.toggleRowSelection(row, shouldSelect);
            });
        },        filterImageOnly() {
            this.fileFilter = 'image';
        },
        filterVideoOnly() {
            this.fileFilter = 'video';
        },
        showAllFiles() {
            this.fileFilter = 'all';
        },
        handleSelectionChange(selection) {
            this.selectedFiles = selection;
        },
        async startBatchIndex() {
            var that = this;
            if (that.selectedFiles.length === 0) {
                ElementPlus.ElMessage.warning('请选择要索引的文件');
                return;
            }

            try {
                that.duplicateDialogVisible = false;
                that.pendingDuplicate = null;
                that.duplicateRememberChoice = false;
                const response = await axios.post('/api/batch_index', {
                    files: that.selectedFiles,
                    target: that.currentLibrary,
                    duplicate_strategy: 'ask'
                });

                that.indexTaskId = response.data.task_id;
                that.addMaterialStep = 2;
                that.indexProgress = 0;
                that.indexStatus = 'running';
                that.currentIndexingFile = '准备中...';

                // 开始轮询进度
                that.pollIndexProgress();
            } catch (error) {
                console.error('启动批量索引失败:', error);
                ElementPlus.ElMessage.error(error.response?.data?.error || '启动批量索引失败');
            }
        },
        async pollIndexProgress() {
            var that = this;
            if (!that.indexTaskId) return;

            that.indexingInterval = setInterval(async () => {
                try {
                    const response = await axios.get(`/api/batch_index/${that.indexTaskId}/status`);
                    that.indexTaskInfo = response.data;
                    that.indexProgress = Math.round(((response.data.progress || 0) * 100));
                    that.currentIndexingFile = response.data.current_file || '处理中...';
                    that.indexStatus = response.data.status;

                    if (response.data.status === 'waiting_duplicate' && response.data.pending_duplicate) {
                        that.pendingDuplicate = response.data.pending_duplicate;
                        that.duplicateDialogVisible = true;
                        that.duplicateDecisionLoading = false;
                    } else if (that.duplicateDialogVisible && response.data.status !== 'waiting_duplicate') {
                        that.duplicateDialogVisible = false;
                        that.pendingDuplicate = null;
                        that.duplicateRememberChoice = false;
                    }

                    if (['completed', 'failed', 'cancelled'].includes(response.data.status)) {
                        clearInterval(that.indexingInterval);
                        that.indexingInterval = null;
                        that.addMaterialStep = 3;

                        await that.loadProjects();
                        await that.loadData();
                    }
                } catch (error) {
                    console.error('查询索引进度失败:', error);
                    clearInterval(that.indexingInterval);
                    that.indexingInterval = null;
                    ElementPlus.ElMessage.error('查询索引进度失败');
                }
            }, 500);
        },
        async cancelBatchIndex() {
            var that = this;
            if (!that.indexTaskId) return;

            try {
                that.cancelling = true;
                await axios.delete(`/api/batch_index/${that.indexTaskId}`);
                ElementPlus.ElMessage.info('索引任务已取消');
                that.duplicateDialogVisible = false;
                that.pendingDuplicate = null;
                that.duplicateRememberChoice = false;

                if (that.indexingInterval) {
                    clearInterval(that.indexingInterval);
                    that.indexingInterval = null;
                }

                that.addMaterialStep = 3;
                that.indexStatus = 'cancelled';
            } catch (error) {
                console.error('取消索引失败:', error);
                ElementPlus.ElMessage.error(error.response?.data?.error || '取消索引失败');
            } finally {
                that.cancelling = false;
            }
        },
        async submitDuplicateDecision(action) {
            if (!this.indexTaskId || !action) return;
            this.duplicateDecisionLoading = true;
            try {
                await axios.post(`/api/batch_index/${this.indexTaskId}/decision`, {
                    action: action,
                    apply_to_all: this.duplicateRememberChoice
                });
                ElementPlus.ElMessage.success(action === 'skip' ? '已跳过当前文件' : '已覆盖当前文件');
                this.duplicateDialogVisible = false;
                this.pendingDuplicate = null;
                this.duplicateRememberChoice = false;
            } catch (error) {
                console.error('提交决策失败:', error);
                ElementPlus.ElMessage.error(error.response?.data?.error || '提交决策失败');
            } finally {
                this.duplicateDecisionLoading = false;
            }
        },        closeAddMaterialDialog() {
            var that = this;
            if (that.indexingInterval) {
                clearInterval(that.indexingInterval);
                that.indexingInterval = null;
            }
            that.detachThumbnailHelpers();

            // 重置状态
            that.showAddMaterialDialog = false;
            that.addMaterialStep = 0;
            that.materialPathInput = '';
            that.previewFiles = [];
            that.selectedFiles = [];
            that.fileFilter = 'all';
            that.indexTaskId = null;
            that.indexTaskInfo = {};
            that.indexProgress = 0;
            that.indexStatus = '';
            that.currentIndexingFile = '';
            that.cancelling = false;
            that.showIndexDetails = false;
            that.activeCollapseNames = [];
        },
        initThumbnailLoader() {
            var that = this;
            if (!that.previewFiles.length) return;
            that.detachThumbnailHelpers();
            var immediate = that.previewFiles.slice(0, 20);
            immediate.forEach(file => {
                if (!file.thumbnailUrl) {
                    that.$set(file, 'thumbnailUrl', `/api/thumbnail?path=${encodeURIComponent(file.path)}&size=128`);
                }
            });
            that.thumbnailQueue = that.previewFiles.slice(20);
            that.scheduleThumbnailLoading();
            that.$nextTick(() => {
                const body = that.$refs.fileTable?.$el?.querySelector('.el-table__body-wrapper');
                if (!body) return;
                if (!that.thumbnailScrollHandler) {
                    that.thumbnailScrollHandler = that.handleThumbnailScroll.bind(that);
                }
                body.addEventListener('scroll', that.thumbnailScrollHandler);
            });
        },
        scheduleThumbnailLoading() {
            if (!this.thumbnailQueue.length || this.thumbnailTimer) return;
            const batch = this.thumbnailQueue.splice(0, 5);
            batch.forEach(file => {
                if (!file.thumbnailUrl) {
                    this.$set(file, 'thumbnailUrl', `/api/thumbnail?path=${encodeURIComponent(file.path)}&size=128`);
                }
            });
            if (this.thumbnailQueue.length) {
                this.thumbnailTimer = setTimeout(() => {
                    this.thumbnailTimer = null;
                    this.scheduleThumbnailLoading();
                }, 400);
            }
        },
        handleThumbnailScroll() {
            const body = this.$refs.fileTable?.$el?.querySelector('.el-table__body-wrapper');
            if (!body || !this.thumbnailQueue.length) return;
            if (body.scrollTop + body.clientHeight >= body.scrollHeight - 120) {
                if (!this.thumbnailTimer) {
                    this.scheduleThumbnailLoading();
                }
            }
        },
        closeAddMaterialDialog() {
            var that = this;
            if (that.indexingInterval) {
                clearInterval(that.indexingInterval);
                that.indexingInterval = null;
            }
            that.detachThumbnailHelpers();

            that.showAddMaterialDialog = false;
            that.addMaterialStep = 0;
            that.materialPathInput = '';
            that.previewFiles = [];
            that.selectedFiles = [];
            that.fileFilter = 'all';
            that.indexTaskId = null;
            that.indexTaskInfo = {};
            that.indexProgress = 0;
            that.indexStatus = '';
            that.currentIndexingFile = '';
            that.cancelling = false;
            that.showIndexDetails = false;
            that.activeCollapseNames = [];
            that.duplicateDialogVisible = false;
            that.pendingDuplicate = null;
            that.duplicateRememberChoice = false;
        },
        detachThumbnailHelpers() {
            if (this.thumbnailTimer) {
                clearTimeout(this.thumbnailTimer);
                this.thumbnailTimer = null;
            }
            const body = this.$refs.fileTable?.$el?.querySelector('.el-table__body-wrapper');
            if (body && this.thumbnailScrollHandler) {
                body.removeEventListener('scroll', this.thumbnailScrollHandler);
            }
            this.thumbnailScrollHandler = null;
            this.thumbnailQueue = [];
        },        formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        },
        formatDuration(seconds) {
            if (seconds < 60) return `${seconds}秒`;
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}分${secs}秒`;
        }
    },
    setup() {
        const upload = Vue.ref();
        const { t } = VueI18n.useI18n({ useScope: "global" });
        function handleExceed(files, fileList) {
            upload.value.clearFiles();
            upload.value.handleStart(files[0]);
            upload.value.submit();
        }
        function handleSuccess() {
            ElementPlus.ElMessage.success(t('messages.uploadSuccess'));
        }
        return {
            upload,
            handleExceed,
            handleSuccess,
        };
    },
})
</script>
<style scoped>
.el-tag {
    margin-right: 2px;
}
.el-select {
    margin-right: 2px;
    padding-top: 2px; // 不加这个会发现select和button对不齐
}
.el-tabs {
    margin-top: 5px;
    width: 100%;
}
.el-input {
    margin-bottom: 2px;
}
.el-upload, .el-upload-dragger {
    width: 100% !important;
}
.el-button {
    border: 0px;
}
.el-button+.el-button {
    margin-left: 2px;
}
.el-upload-list__item:first-child {
    margin-top: 0px;
}
.el-tabs--border-card>.el-tabs__content {
    padding: 10px 15px;
}
.el-card__body {
    padding: 10px;
}
.el-image {
    width: 100%;
    max-height: 240px;
    margin-bottom: 2px;
}
.add-material-actions {
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
}
.history-dropdown {
    max-height: 240px;
    overflow-y: auto;
    width: 320px;
}
.history-entry {
    display: flex;
    flex-direction: column;
}
.history-path {
    font-size: 13px;
    color: #303133;
}
.history-time {
    font-size: 11px;
    color: #909399;
}
.duplicate-block {
    margin-bottom: 16px;
}
.duplicate-block h4 {
    margin: 0 0 4px 0;
    font-size: 14px;
    color: #303133;
}
.duplicate-path {
    font-size: 12px;
    color: #909399;
    word-break: break-all;
}
.duplicate-preview {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-top: 8px;
}
.duplicate-preview img,
.thumb-placeholder {
    width: 64px;
    height: 64px;
    border-radius: 4px;
    object-fit: cover;
    background: #f5f7fa;
    display: flex;
    align-items: center;
    justify-content: center;
}
.thumb-placeholder i {
    font-size: 20px;
    color: #909399;
}
.dialog-spacer {
    flex: 1;
}
video {
    width: 100%;
    max-height: 240px;
    margin-bottom: 2px;
}
</style>
</html>










