# Change: 改进项目库素材上传体验

## Why

当前项目库的素材添加方式需要用户手动输入文件夹路径，然后通过扫描对话框添加路径后批量扫描。这种方式存在以下问题：

1. **操作繁琐**：需要记住或复制粘贴完整的UNC路径（如 `\\Daga-nas5\daga-2025-project\...`）
2. **缺乏预览**：无法在索引前查看将要处理的文件列表
3. **无法筛选**：不能手动剔除不需要的文件（如临时文件、系统文件）
4. **体验割裂**：相比永久库的拖拽上传，项目库的体验明显不够友好

对于单个项目素材较少（10-100个文件）且需要分批添加的场景，需要更便捷的上传方式。

## What Changes

- **前端UI改进**
  - 在切换到项目库时显示"添加素材"区域，切换到永久库时隐藏
  - 支持复制粘贴文件/文件夹路径（混合模式）
  - 提供文件预览列表（含缩略图、文件名、大小）
  - 支持手动勾选/取消勾选文件
  - 显示实时索引进度（进度条、剩余时间）

- **路径解析逻辑**
  - 自动识别粘贴内容中的文件路径和文件夹路径
  - 对文件夹路径进行递归遍历
  - 合并所有文件到统一列表

- **智能功能**
  - 缩略图懒加载（首屏20个立即生成，其余滚动时生成）
  - 自动识别已索引文件（基于phash），仅勾选新文件
  - 智能过滤临时文件（`~$`、`.tmp`等）
  - 历史路径记忆（按项目分组）

- **批量索引流程**
  - 支持批量文件处理（10-100个）
  - 跳过失败文件，完成后显示报告
  - 重复文件检测（phash对比）+ 用户决策
  - "记住选择"功能（避免重复点击）

- **后端API增强**
  - 新增 `POST /api/preview_files` - 接收路径列表，返回文件元信息
  - 新增 `POST /api/generate_thumbnail` - 按需生成缩略图
  - 新增 `POST /api/batch_index` - 批量索引文件
  - 扩展 `GET /api/scan` - 支持接收文件路径数组（而不仅是目录路径）

## Impact

- **受影响的规范**：
  - `upload-to-library` - MODIFIED：从单文件上传改为批量路径索引
  - `frontend-library-ui` - MODIFIED：添加新的素材上传UI组件
  - `batch-indexing` - ADDED：新增批量索引能力

- **受影响的代码**：
  - `static/index.html` - 添加"添加素材"对话框组件（约200行）
  - `routes.py` - 新增3个API端点（约150行）
  - `scan.py` - 修改扫描逻辑，支持文件路径数组（约50行）
  - `utils_image.py` - 缩略图生成函数复用（无需修改）

- **用户体验改进**：
  - 操作步骤：从"输入路径→扫描→等待"变为"粘贴路径→预览→勾选→索引"
  - 时间节省：减少30-50%的操作时间（预览和筛选提前完成）
  - 错误率降低：可视化预览减少误操作

## Dependencies

- 无外部依赖
- 复用现有的图片处理和扫描逻辑
- 前端使用 ElementPlus 现有组件

## Risks

- **性能风险**：100个文件的缩略图生成可能需要10-20秒
  - **缓解**：使用懒加载策略，首屏优先

- **路径兼容性**：Windows UNC路径、映射盘符、相对路径的处理
  - **缓解**：后端统一路径格式处理

- **浏览器限制**：无法通过拖拽直接获取文件路径
  - **缓解**：使用复制粘贴方式，在文档中明确说明操作方法

## Non-Goals

- 不支持直接拖拽文件/文件夹（受浏览器安全策略限制）
- 不改变永久库的上传方式（保持现有体验）
- 不支持移动端浏览器（路径复制粘贴在移动端不适用）
