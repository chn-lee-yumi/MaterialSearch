# 实施任务清单

## 1. 后端 API 实现

### 1.1 路径预览 API
- [ ] 1.1.1 在 `routes.py` 新增 `POST /api/preview_files` 端点
- [ ] 1.1.2 实现路径解析逻辑（区分文件/文件夹）
- [ ] 1.1.3 实现文件夹递归遍历（`os.walk`）
- [ ] 1.1.4 实现文件格式过滤（基于 `IMAGE_EXTENSIONS` 和 `VIDEO_EXTENSIONS`）
- [ ] 1.1.5 实现临时文件智能过滤（`~$`、`.DS_Store` 等）
- [ ] 1.1.6 实现路径规范化函数（UNC路径、映射盘符处理）
- [ ] 1.1.7 实现 phash 检测已索引文件（查询数据库）
- [ ] 1.1.8 返回文件元信息 JSON（路径、大小、类型、is_indexed）

### 1.2 缩略图生成 API
- [ ] 1.2.1 在 `routes.py` 新增 `GET /api/thumbnail` 端点
- [ ] 1.2.2 实现缩略图生成函数（复用 `utils_image.py` 中的 Pillow 逻辑）
- [ ] 1.2.3 实现缩略图缓存机制（`/tmp/thumbnails/`，使用路径 MD5 作为键）
- [ ] 1.2.4 实现视频首帧提取（使用 OpenCV）
- [ ] 1.2.5 实现 PDF 首页渲染（如果安装了 `pdf2image`，否则返回默认图标）
- [ ] 1.2.6 实现大文件超时保护（5秒超时）
- [ ] 1.2.7 实现缓存过期清理（7天自动删除）

### 1.3 批量索引 API
- [ ] 1.3.1 在 `routes.py` 新增 `POST /api/batch_index` 端点
- [ ] 1.3.2 创建任务管理数据结构（内存字典 `indexing_tasks`）
- [ ] 1.3.3 实现任务 ID 生成（UUID）
- [ ] 1.3.4 实现后台线程处理函数 `process_batch`
- [ ] 1.3.5 实现串行文件处理逻辑（for 循环，避免并发写入）
- [ ] 1.3.6 实现进度更新机制（每处理1个文件更新进度）
- [ ] 1.3.7 实现错误捕获和记录（失败文件列表）
- [ ] 1.3.8 实现重复文件检测（phash 对比）
- [ ] 1.3.9 实现重复策略处理（ask/skip/overwrite）

### 1.4 任务状态查询 API
- [ ] 1.4.1 在 `routes.py` 新增 `GET /api/batch_index/<task_id>/status` 端点
- [ ] 1.4.2 返回任务进度 JSON（total, processed, success, failed, duplicates）
- [ ] 1.4.3 实现任务完成状态判断（processed >= total）

### 1.5 任务取消 API
- [ ] 1.5.1 在 `routes.py` 新增 `DELETE /api/batch_index/<task_id>` 端点
- [ ] 1.5.2 实现取消标志设置
- [ ] 1.5.3 在处理循环中检测取消标志
- [ ] 1.5.4 返回部分完成报告

### 1.6 批量特征提取优化
- [ ] 1.6.1 修改 `scan.py` 中的特征提取逻辑，支持 batch 模式
- [ ] 1.6.2 实现文件批量读取（最多12个一组）
- [ ] 1.6.3 单次调用 CLIP 模型处理 batch
- [ ] 1.6.4 返回 batch 结果数组

---

## 2. 前端 UI 实现

### 2.1 添加素材对话框组件
- [ ] 2.1.1 在 `static/index.html` 添加 "添加素材" 按钮（位于 "项目管理" 旁边）
- [ ] 2.1.2 实现按钮显示/隐藏逻辑（仅项目库模式显示）
- [ ] 2.1.3 创建 `<el-dialog>` 对话框组件
- [ ] 2.1.4 实现对话框标题动态显示（"为项目添加素材：项目名"）

### 2.2 路径输入区域
- [ ] 2.2.1 添加多行文本输入框（`<el-input type="textarea">`）
- [ ] 2.2.2 实现粘贴事件处理（`@paste`）
- [ ] 2.2.3 实现路径解析逻辑（去除引号、按行分割）
- [ ] 2.2.4 添加 "历史路径" 下拉菜单组件
- [ ] 2.2.5 实现历史路径 localStorage 存储和读取
- [ ] 2.2.6 添加 "预览文件" 按钮

### 2.3 文件预览列表
- [ ] 2.3.1 创建文件列表表格组件（`<el-table>`）
- [ ] 2.3.2 实现表格列：勾选框、类型图标、缩略图、文件名、大小
- [ ] 2.3.3 实现 `handlePreviewFiles` 函数（调用 `/api/preview_files`）
- [ ] 2.3.4 实现加载动画显示
- [ ] 2.3.5 实现文件数据绑定（`this.files = response.data`）

### 2.4 缩略图懒加载
- [ ] 2.4.1 实现首屏20个缩略图立即加载
- [ ] 2.4.2 添加滚动事件监听（`@scroll`）
- [ ] 2.4.3 实现可见区域检测（IntersectionObserver 或手动计算）
- [ ] 2.4.4 实现按需请求缩略图（`/api/thumbnail`）
- [ ] 2.4.5 实现缩略图加载状态显示（占位符 → 加载中 → 缩略图）
- [ ] 2.4.6 实现并发限制（最多5个并发请求）

### 2.5 文件筛选功能
- [ ] 2.5.1 添加 "全选" 按钮及实现
- [ ] 2.5.2 添加 "反选" 按钮及实现
- [ ] 2.5.3 添加 "仅图片" / "仅视频" 筛选按钮
- [ ] 2.5.4 实现已索引文件标识（灰色 + "已索引" 标签）
- [ ] 2.5.5 实现底部统计显示（"已选择 X 个文件，总大小 Y MB"）

### 2.6 索引进度显示
- [ ] 2.6.1 添加 "开始索引" 按钮
- [ ] 2.6.2 实现 `startIndexing` 函数（调用 `/api/batch_index`）
- [ ] 2.6.3 实现进度轮询函数 `pollProgress`（每500ms查询一次）
- [ ] 2.6.4 添加进度条组件（`<el-progress>`）
- [ ] 2.6.5 实现当前文件名显示（"正在索引: image_10.jpg (10/25)"）
- [ ] 2.6.6 实现预计剩余时间显示
- [ ] 2.6.7 添加 "取消" 按钮及实现

### 2.7 完成报告对话框
- [ ] 2.7.1 创建完成报告对话框组件
- [ ] 2.7.2 实现成功/失败/重复统计显示
- [ ] 2.7.3 添加 "查看详情" 按钮
- [ ] 2.7.4 实现详情展开（失败文件列表 + 错误原因）
- [ ] 2.7.5 添加 "关闭" 按钮

### 2.8 重复文件对话框
- [ ] 2.8.1 创建重复文件对比对话框组件
- [ ] 2.8.2 实现左右分栏布局（已有文件 | 新文件）
- [ ] 2.8.3 实现缩略图对比显示
- [ ] 2.8.4 实现文件信息对比（路径、大小、修改时间）
- [ ] 2.8.5 添加操作按钮："跳过"、"覆盖"、"全部跳过"、"全部覆盖"
- [ ] 2.8.6 添加 "记住选择" 复选框
- [ ] 2.8.7 实现决策传递给后端（更新 `duplicate_strategy`）

### 2.9 历史路径管理
- [ ] 2.9.1 实现路径保存到 localStorage（索引成功后）
- [ ] 2.9.2 实现按项目ID分组存储
- [ ] 2.9.3 实现历史路径显示（最多10条，按时间倒序）
- [ ] 2.9.4 添加 "清空历史" 功能

### 2.10 响应式适配
- [ ] 2.10.1 实现桌面端布局（1024px+）
- [ ] 2.10.2 实现笔记本布局（768px-1024px）
- [ ] 2.10.3 移动端禁用提示（< 768px）

---

## 3. 数据库和存储

### 3.1 缓存目录管理
- [ ] 3.1.1 创建缩略图缓存目录（`/tmp/thumbnails/`）
- [ ] 3.1.2 实现缓存清理脚本（定时任务或启动时清理7天前文件）

### 3.2 项目库统计更新
- [ ] 3.2.1 修改批量索引完成后的统计更新逻辑
- [ ] 3.2.2 更新项目元信息库（`image_count`, `total_size`, `updated_time`）

---

## 4. 测试和验证

### 4.1 后端 API 测试
- [ ] 4.1.1 测试 `/api/preview_files` - 单个文件路径
- [ ] 4.1.2 测试 `/api/preview_files` - 单个文件夹路径
- [ ] 4.1.3 测试 `/api/preview_files` - 混合路径
- [ ] 4.1.4 测试 `/api/preview_files` - 路径不存在错误处理
- [ ] 4.1.5 测试 `/api/thumbnail` - 图片缩略图生成
- [ ] 4.1.6 测试 `/api/thumbnail` - 视频首帧提取
- [ ] 4.1.7 测试 `/api/thumbnail` - 缓存命中
- [ ] 4.1.8 测试 `/api/batch_index` - 批量索引流程
- [ ] 4.1.9 测试 `/api/batch_index/<task_id>/status` - 进度查询
- [ ] 4.1.10 测试 `DELETE /api/batch_index/<task_id>` - 任务取消

### 4.2 前端 UI 测试
- [ ] 4.2.1 测试按钮显示/隐藏（切换项目库/永久库）
- [ ] 4.2.2 测试路径粘贴解析
- [ ] 4.2.3 测试文件预览列表显示
- [ ] 4.2.4 测试缩略图懒加载
- [ ] 4.2.5 测试文件筛选功能（全选、反选、按类型）
- [ ] 4.2.6 测试索引进度显示
- [ ] 4.2.7 测试重复文件对话框交互
- [ ] 4.2.8 测试完成报告显示

### 4.3 集成测试
- [ ] 4.3.1 测试完整流程：粘贴路径 → 预览 → 筛选 → 索引 → 完成
- [ ] 4.3.2 测试重复文件处理流程（ask模式）
- [ ] 4.3.3 测试错误文件跳过流程
- [ ] 4.3.4 测试取消任务流程
- [ ] 4.3.5 测试历史路径保存和恢复

### 4.4 性能测试
- [ ] 4.4.1 测试 10 个文件的索引性能
- [ ] 4.4.2 测试 50 个文件的索引性能
- [ ] 4.4.3 测试 100 个文件的索引性能
- [ ] 4.4.4 测试缩略图生成性能（50个图片）
- [ ] 4.4.5 测试 GPU batch 处理效果（对比单个处理）

### 4.5 边界情况测试
- [ ] 4.5.1 测试空路径输入
- [ ] 4.5.2 测试无效路径格式
- [ ] 4.5.3 测试超大文件（> 100MB）
- [ ] 4.5.4 测试损坏文件处理
- [ ] 4.5.5 测试网络中断时的任务恢复

---

## 5. 文档和优化

### 5.1 代码优化
- [ ] 5.1.1 代码审查和重构（提取公共函数）
- [ ] 5.1.2 添加必要的代码注释
- [ ] 5.1.3 错误处理优化（统一错误格式）
- [ ] 5.1.4 日志记录完善（关键操作记录）

### 5.2 用户文档
- [ ] 5.2.1 编写用户操作指南（如何复制路径）
- [ ] 5.2.2 添加界面提示文案（工具提示、占位符）
- [ ] 5.2.3 编写常见问题解答（路径格式、权限问题等）

### 5.3 部署准备
- [ ] 5.3.1 更新 `README.md`（新功能说明）
- [ ] 5.3.2 更新 `CHANGELOG.md`（版本记录）
- [ ] 5.3.3 创建数据库迁移脚本（如需要）

---

## 6. 兼容性和迁移

### 6.1 保留现有功能
- [ ] 6.1.1 确保原有扫描对话框仍可用
- [ ] 6.1.2 确保永久库上传不受影响
- [ ] 6.1.3 测试与现有项目管理功能的兼容性

### 6.2 灰度发布
- [ ] 6.2.1 添加功能开关（环境变量控制新功能启用）
- [ ] 6.2.2 收集用户反馈
- [ ] 6.2.3 根据反馈优化

---

## 实施优先级

### P0 - 核心功能（必须完成）
- 后端 API: 1.1, 1.3, 1.4
- 前端 UI: 2.1-2.3, 2.5-2.6
- 测试: 4.1, 4.2, 4.3

### P1 - 重要功能（应该完成）
- 后端 API: 1.2, 1.5, 1.6
- 前端 UI: 2.4, 2.7, 2.8
- 测试: 4.4

### P2 - 优化功能（可以完成）
- 前端 UI: 2.9, 2.10
- 文档: 5.1-5.3
- 测试: 4.5

---

## 依赖关系

- 1.1 必须在 2.3 之前完成（前端需要 API）
- 1.2 必须在 2.4 之前完成（缩略图 API）
- 1.3 必须在 2.6 之前完成（批量索引 API）
- 1.4 必须在 2.6.3 之前完成（进度查询 API）
- 2.1-2.2 必须在 2.3 之前完成（对话框基础）
- 4.1-4.2 必须在 4.3 之前完成（单元测试先于集成测试）

---

## 预计工作量

- **后端实现**：约 8-10 小时
- **前端实现**：约 12-15 小时
- **测试和优化**：约 5-6 小时
- **文档编写**：约 2-3 小时
- **总计**：约 27-34 小时（约 3-4 个工作日）
