# Change: 添加项目数据库架构（双库分离）

## Why

建筑设计行业的素材管理存在"临时项目文件"与"永久精选素材"混杂的问题：

1. **混杂问题**：每个项目产生数百张临时图片，与精心筛选的参考素材混在一起，难以管理
2. **检索效率**：在包含大量临时文件的数据库中搜索永久素材，效率低且结果干扰严重
3. **归档困难**：项目完成后，需要人工筛选哪些图片值得保留到永久库，缺乏流程支持
4. **项目隔离**：无法按项目维度查看和管理素材，多项目并行时容易混乱
5. **生命周期**：临时项目文件和永久素材的生命周期不同，应该分开存储和管理

**实际场景**：
- 公司年均 50 个项目，每项目约 100 张临时图片
- 永久库需要精选的高质量参考素材（约 1 万张）
- 20 人团队通过 NAS 共享文件，需要多人协作支持

## What Changes

### 核心架构变更

**从单一数据库架构改为双库架构**：

- **永久库（permanent.db）**：存储精选的、可复用的参考素材
  - 高质量参考图片
  - 经过分类和标记
  - 支持全局搜索

- **项目库（proj_*.db）**：每个项目一个独立数据库
  - 项目临时文件
  - 按项目隔离
  - 项目完成后可归档或删除

- **项目元信息库（projects_metadata.db）**：管理所有项目信息
  - 项目基本信息
  - 统计数据
  - 项目状态

### 数据库 Schema 扩展

**新增字段（所有数据库）**：
- 文件属性：`width`、`height`、`aspect_ratio`、`aspect_ratio_standard`、`file_size`、`file_format`
- 时间戳：`upload_time`、`last_accessed`
- 分类标签：`category`、`sub_category`、`tags`、`building_type`、`design_style`
- 来源信息：`source_type`、`source_project`、`source_notes`
- 质量管理：`quality_score`、`is_featured`
- 去重预留：`phash`、`duplicate_group`、`is_duplicate`
- AI 增强：`ai_description`、`ai_description_vector`
- 软删除：`is_deleted`、`deleted_time`

**项目库特有字段**：
- 项目分类：`image_type`、`stage`、`space_type`
- 版本管理：`version`、`parent_id`
- 审批流程：`is_approved`、`approved_by`、`approved_time`
- 归档状态：`archived`、`archived_to_id`、`archived_time`

### 新增功能

1. **项目管理**
   - 创建项目（手动输入项目名称、客户名等）
   - 项目列表展示（活跃/已完成/已归档）
   - 项目详情查看
   - 项目删除（数据库文件保留）

2. **素材上传与搜索**
   - 上传时选择目标（永久库或指定项目）
   - 项目内搜索（仅搜索指定项目）
   - 永久库搜索（搜索精选素材）
   - 全局搜索（可选，搜索所有项目+永久库）

3. **归档流程**
   - 项目完成后，选择图片归档到永久库
   - 复制图片记录和向量特征
   - 标记来源项目
   - 文件路径保持不变（NAS 上）

4. **备份方案**
   - 每日自动备份所有数据库文件
   - 保留 30 天历史备份
   - 支持单项目恢复

### 非目标（本提案不包含）

- ❌ 图片去重功能（留待后续提案）
- ❌ AI Agent 集成（留待后续提案）
- ❌ 性能优化（向量索引）（留待后续提案）
- ❌ 用户权限管理（当前版本所有人权限相同）

## Impact

### 受影响的规范

- **project-management**（新增）：项目 CRUD、项目切换、统计信息
- **image-storage**（修改）：数据库架构、Schema 扩展、多库支持
- **search**（修改）：支持指定库搜索、结果来源标注

### 受影响的代码

**核心模块**：
- `models.py`：新增 Project 模型，扩展 Image/Video 字段
- `database.py`：多数据库连接管理，增加项目数据库操作
- `scan.py`：上传时计算新增字段（宽高比、文件格式等）
- `search.py`：支持指定库搜索，结果合并
- `routes.py`：新增项目管理 API

**新增模块**：
- `project_manager.py`：项目生命周期管理
- `archive.py`：归档流程实现
- `backup.sh`：自动备份脚本

**前端变更**：
- `static/index.html`：添加项目选择器、归档按钮

### 数据迁移

**现有数据处理**：
- 现有 `image` 和 `video` 表数据保留
- 自动为旧数据填充默认值（如 `project_id=NULL` 表示永久库）
- 新增字段可为 NULL，不影响现有功能

**迁移步骤**（自动化脚本）：
1. 备份现有数据库
2. 执行 ALTER TABLE 添加新字段
3. 为现有记录计算宽高比等属性
4. 创建新索引

### 部署影响

- **部署环境**：需要 Linux 服务器（已准备）
- **存储需求**：数据库文件在服务器本地磁盘（约 10MB/项目）
- **NAS 挂载**：需配置 NAS 路径（图片文件仍在 NAS）
- **备份配置**：需设置定时任务（cron）

### 性能影响

- **正面影响**：
  - 项目内搜索更快（仅扫描 100 张 vs 全库 6 万张）
  - 写入冲突减少（项目独立数据库）

- **可能风险**：
  - 全局搜索需打开多个数据库文件（但用户很少使用）
  - 管理复杂度略微增加

### 破坏性变更

- **BREAKING**：API 接口变更
  - 搜索 API 新增 `library_type` 参数（`permanent` / `project` / `all`）
  - 上传 API 新增 `target` 参数（`permanent` / `project_id`）

- **向后兼容**：
  - 旧的搜索请求默认搜索永久库
  - 旧的上传请求默认上传到永久库
  - 现有数据库结构兼容（新字段可为 NULL）

## Risks and Mitigations

### 风险 1：数据迁移失败
- **风险**：ALTER TABLE 操作可能失败，导致数据损坏
- **缓解**：
  - 迁移前强制备份
  - 提供回滚脚本
  - 在测试环境先验证

### 风险 2：NAS 连接不稳定
- **风险**：NAS 断连导致图片无法访问
- **缓解**：
  - 数据库仅存路径，图片实时读取
  - 前端显示"图片暂时不可用"而非系统崩溃
  - 搜索和向量功能不受影响（向量在数据库中）

### 风险 3：备份空间不足
- **风险**：30 天备份占用大量空间
- **缓解**：
  - 数据库文件很小（10MB/项目）
  - 可配置保留天数
  - 监控磁盘空间，自动清理

## Timeline

- **设计和评审**：3 天
- **开发实施**：7-10 天
- **测试和优化**：3 天
- **部署和迁移**：1 天

**总计**：约 2 周

## Success Metrics

- ✅ 项目内搜索响应时间 < 1 秒（100 张图）
- ✅ 永久库搜索响应时间 < 3 秒（1 万张图）
- ✅ 支持 50+ 项目并行管理
- ✅ 归档操作成功率 100%
- ✅ 数据迁移零丢失
- ✅ 备份恢复测试通过
