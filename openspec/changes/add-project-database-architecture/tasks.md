# Implementation Tasks: 项目数据库架构

## 依赖关系说明
- 🔗 表示任务有依赖，需等待前置任务完成
- ⚡ 表示可并行执行
- 📝 表示需要文档更新

---

## 1. 数据库 Schema 设计与迁移

### 1.1 创建新的数据库模型
- [ ] 1.1.1 在 `models.py` 中定义 `Project` 模型
- [ ] 1.1.2 扩展 `Image` 模型：添加新字段（宽高比、分类、时间戳等）
- [ ] 1.1.3 扩展 `Video` 模型：添加对应字段
- [ ] 1.1.4 为项目库定义 `ProjectImage` 和 `ProjectVideo` 模型
- [ ] 1.1.5 编写数据库迁移脚本 `migrations/add_project_schema.py`

**预期产出**：
- 更新后的 `models.py`（约 +150 行）
- 迁移脚本 `migrations/add_project_schema.py`

---

### 1.2 实现多数据库连接管理 🔗（依赖 1.1）
- [ ] 1.2.1 在 `database.py` 中添加 `ProjectDatabaseManager` 类
- [ ] 1.2.2 实现动态数据库连接（根据 project_id 获取对应数据库）
- [ ] 1.2.3 实现项目元信息数据库（`projects_metadata.db`）
- [ ] 1.2.4 添加数据库初始化函数（创建永久库和项目库表结构）
- [ ] 1.2.5 配置 WAL 模式（提升并发性能）

**预期产出**：
- 更新后的 `database.py`（约 +200 行）
- 新增 `ProjectDatabaseManager` 类

---

### 1.3 编写数据迁移脚本 🔗（依赖 1.2）
- [ ] 1.3.1 备份现有数据库
- [ ] 1.3.2 执行 ALTER TABLE 添加新字段
- [ ] 1.3.3 为现有图片计算属性（宽度、高度、宽高比、文件大小）
- [ ] 1.3.4 创建新索引
- [ ] 1.3.5 验证数据完整性
- [ ] 1.3.6 编写回滚脚本

**预期产出**：
- `scripts/migrate_database.py`
- `scripts/rollback_migration.py`
- 迁移日志和验证报告

---

## 2. 项目管理核心功能

### 2.1 实现项目管理模块 ⚡（可与 1.3 并行）
- [ ] 2.1.1 创建 `project_manager.py` 模块
- [ ] 2.1.2 实现 `create_project()` - 创建项目和数据库文件
- [ ] 2.1.3 实现 `list_projects()` - 列出所有项目（支持状态筛选）
- [ ] 2.1.4 实现 `get_project_info()` - 获取项目详情和统计信息
- [ ] 2.1.5 实现 `update_project()` - 更新项目元信息
- [ ] 2.1.6 实现 `delete_project()` - 删除项目（软删除）
- [ ] 2.1.7 实现项目统计信息更新（图片数、总大小等）

**预期产出**：
- 新文件 `project_manager.py`（约 300 行）

---

### 2.2 实现项目管理 API 🔗（依赖 2.1）
- [ ] 2.2.1 `POST /api/projects` - 创建项目
- [ ] 2.2.2 `GET /api/projects` - 获取项目列表
- [ ] 2.2.3 `GET /api/projects/:id` - 获取项目详情
- [ ] 2.2.4 `PUT /api/projects/:id` - 更新项目信息
- [ ] 2.2.5 `DELETE /api/projects/:id` - 删除项目
- [ ] 2.2.6 `GET /api/projects/:id/stats` - 获取项目统计数据
- [ ] 2.2.7 在 `routes.py` 中注册这些路由

**预期产出**：
- 更新后的 `routes.py`（约 +150 行）

---

## 3. 素材上传与扫描

### 3.1 扩展扫描模块支持新字段 🔗（依赖 1.1）
- [ ] 3.1.1 更新 `scan.py` 中的图片处理函数
- [ ] 3.1.2 添加宽高比计算逻辑
- [ ] 3.1.3 添加标准比例识别函数 `get_standard_aspect_ratio()`
- [ ] 3.1.4 添加文件格式识别
- [ ] 3.1.5 添加感知哈希计算（为去重预留）
- [ ] 3.1.6 测试新字段提取准确性

**预期产出**：
- 更新后的 `scan.py`（约 +100 行）

---

### 3.2 支持指定目标库上传 🔗（依赖 2.1, 3.1）
- [ ] 3.2.1 修改上传 API：添加 `target` 参数（`permanent` 或 `project_id`）
- [ ] 3.2.2 实现上传队列机制（避免并发写入冲突）
- [ ] 3.2.3 根据 target 参数选择目标数据库
- [ ] 3.2.4 上传时自动更新项目统计信息
- [ ] 3.2.5 测试并发上传场景

**预期产出**：
- 更新后的 `routes.py` 上传接口
- 新增 `upload_queue.py` 队列管理模块

---

## 4. 搜索功能增强

### 4.1 支持多库搜索 🔗（依赖 1.2）
- [ ] 4.1.1 更新 `search.py`：添加 `library_type` 参数
- [ ] 4.1.2 实现永久库搜索（仅搜索 permanent.db）
- [ ] 4.1.3 实现项目库搜索（搜索指定项目数据库）
- [ ] 4.1.4 实现全局搜索（可选，搜索所有库）
- [ ] 4.1.5 结果中标注来源（permanent / project_name）
- [ ] 4.1.6 性能测试和优化

**预期产出**：
- 更新后的 `search.py`（约 +150 行）

---

### 4.2 更新搜索 API 🔗（依赖 4.1）
- [ ] 4.2.1 修改 `/api/search/image` 接口：添加 `library_type` 和 `project_id` 参数
- [ ] 4.2.2 修改 `/api/search/video` 接口：同样添加参数
- [ ] 4.2.3 保持向后兼容（未指定参数时默认搜索永久库）
- [ ] 4.2.4 返回结果中包含来源信息
- [ ] 4.2.5 更新 API 文档

**预期产出**：
- 更新后的 `routes.py` 搜索接口
- 📝 API 文档更新

---

## 5. 归档功能

### 5.1 实现归档模块 🔗（依赖 1.2, 2.1）
- [ ] 5.1.1 创建 `archive.py` 模块
- [ ] 5.1.2 实现 `archive_images_to_permanent()` 函数
  - 从项目库读取图片记录（包括向量特征）
  - 插入永久库（设置来源信息）
  - 更新项目库记录（标记已归档）
- [ ] 5.1.3 实现 `archive_videos_to_permanent()` 函数（视频归档）
- [ ] 5.1.4 实现批量归档功能
- [ ] 5.1.5 添加归档失败回滚机制
- [ ] 5.1.6 测试归档数据完整性

**预期产出**：
- 新文件 `archive.py`（约 200 行）

---

### 5.2 实现归档 API 🔗（依赖 5.1）
- [ ] 5.2.1 `POST /api/projects/:id/archive` - 归档选定的图片到永久库
- [ ] 5.2.2 验证归档参数（图片 ID 列表）
- [ ] 5.2.3 返回归档结果（成功数、失败数）
- [ ] 5.2.4 更新项目统计信息
- [ ] 5.2.5 测试归档流程

**预期产出**：
- 更新后的 `routes.py`（约 +50 行）

---

## 6. 前端界面更新

### 6.1 项目选择器 🔗（依赖 2.2）
- [ ] 6.1.1 在前端添加项目下拉选择器
- [ ] 6.1.2 获取项目列表并展示
- [ ] 6.1.3 切换项目时更新搜索范围
- [ ] 6.1.4 显示当前项目信息（名称、图片数）
- [ ] 6.1.5 添加"永久库"选项

**预期产出**：
- 更新后的 `static/index.html`（约 +100 行）

---

### 6.2 项目管理界面 ⚡（可与 6.1 并行）
- [ ] 6.2.1 创建项目管理页面 `static/projects.html`
- [ ] 6.2.2 实现项目列表展示
- [ ] 6.2.3 实现创建项目表单
- [ ] 6.2.4 实现项目编辑功能
- [ ] 6.2.5 实现项目删除（带确认提示）
- [ ] 6.2.6 显示项目统计信息（图片数、视频数、总大小）

**预期产出**：
- 新文件 `static/projects.html`（约 300 行）
- 更新 `static/index.html` 添加入口链接

---

### 6.3 归档功能界面 🔗（依赖 5.2, 6.1）
- [ ] 6.3.1 在搜索结果中添加批量选择功能
- [ ] 6.3.2 添加"归档到永久库"按钮（仅项目库显示）
- [ ] 6.3.3 实现归档确认对话框
- [ ] 6.3.4 显示归档进度和结果
- [ ] 6.3.5 归档后刷新列表

**预期产出**：
- 更新后的 `static/index.html`（约 +80 行）

---

## 7. 配置和工具

### 7.1 配置文件更新 ⚡（可早期完成）
- [ ] 7.1.1 在 `config.py` 中添加多库配置项
  - `PROJECT_DATABASE_DIR`：项目库目录路径
  - `METADATA_DATABASE_PATH`：元信息库路径
  - `ENABLE_WAL_MODE`：是否启用 WAL 模式
- [ ] 7.1.2 添加备份配置项
  - `BACKUP_DIR`：备份目录路径
  - `BACKUP_RETENTION_DAYS`：备份保留天数
- [ ] 7.1.3 更新环境变量示例 `.env.example`

**预期产出**：
- 更新后的 `config.py`（约 +30 行）
- 更新后的 `.env.example`

---

### 7.2 备份脚本 ⚡（可并行开发）
- [ ] 7.2.1 创建备份脚本 `scripts/backup.sh`
- [ ] 7.2.2 实现数据库文件备份逻辑
- [ ] 7.2.3 实现压缩和归档
- [ ] 7.2.4 实现自动清理旧备份
- [ ] 7.2.5 添加日志记录
- [ ] 7.2.6 编写恢复脚本 `scripts/restore.sh`
- [ ] 7.2.7 测试备份和恢复流程

**预期产出**：
- `scripts/backup.sh`
- `scripts/restore.sh`
- Cron 配置示例

---

### 7.3 管理工具 ⚡（可并行开发）
- [ ] 7.3.1 创建 CLI 管理工具 `manage.py`
- [ ] 7.3.2 实现 `manage.py init` - 初始化数据库结构
- [ ] 7.3.3 实现 `manage.py migrate` - 执行数据迁移
- [ ] 7.3.4 实现 `manage.py create-project <name>` - 命令行创建项目
- [ ] 7.3.5 实现 `manage.py list-projects` - 列出所有项目
- [ ] 7.3.6 实现 `manage.py stats` - 显示系统统计信息
- [ ] 7.3.7 实现 `manage.py backup` - 手动触发备份

**预期产出**：
- 新文件 `manage.py`（约 200 行）

---

## 8. 测试与验证

### 8.1 单元测试 🔗（各模块完成后）
- [ ] 8.1.1 测试项目管理模块（创建、删除、查询）
- [ ] 8.1.2 测试多数据库连接管理
- [ ] 8.1.3 测试归档功能（数据完整性）
- [ ] 8.1.4 测试宽高比计算准确性
- [ ] 8.1.5 测试搜索功能（永久库、项目库、全局）
- [ ] 8.1.6 测试队列并发上传

**预期产出**：
- 测试脚本 `tests/test_project_architecture.py`

---

### 8.2 集成测试 🔗（依赖所有功能）
- [ ] 8.2.1 端到端测试：创建项目 → 上传 → 搜索 → 归档
- [ ] 8.2.2 测试多项目并行场景
- [ ] 8.2.3 测试数据迁移流程（旧数据 → 新架构）
- [ ] 8.2.4 测试备份和恢复
- [ ] 8.2.5 压力测试（并发上传、大量搜索）
- [ ] 8.2.6 性能测试（项目内搜索 vs 全局搜索）

**预期产出**：
- 测试报告
- 性能基准数据

---

### 8.3 用户验收测试 🔗（依赖 8.2）
- [ ] 8.3.1 部署到测试环境
- [ ] 8.3.2 邀请用户测试项目创建和管理
- [ ] 8.3.3 验证搜索功能符合预期
- [ ] 8.3.4 验证归档流程的易用性
- [ ] 8.3.5 收集反馈并优化

**预期产出**：
- 用户反馈报告
- 优化改进列表

---

## 9. 文档与部署

### 9.1 文档更新 📝 ⚡（可并行编写）
- [ ] 9.1.1 更新 `README_ZH.md`：添加项目管理功能说明
- [ ] 9.1.2 编写项目管理使用教程
- [ ] 9.1.3 编写 API 文档（新增接口）
- [ ] 9.1.4 编写数据库 Schema 文档
- [ ] 9.1.5 编写备份恢复操作手册
- [ ] 9.1.6 编写故障排查指南

**预期产出**：
- 更新后的 `README_ZH.md`
- 新文档 `docs/project_management.md`
- 新文档 `docs/api_reference.md`
- 新文档 `docs/database_schema.md`
- 新文档 `docs/backup_restore.md`

---

### 9.2 部署准备 🔗（依赖 8.3）
- [ ] 9.2.1 准备生产环境 Linux 服务器
- [ ] 9.2.2 配置 NAS 挂载（/mnt/nas）
- [ ] 9.2.3 安装依赖（Python、SQLite）
- [ ] 9.2.4 配置环境变量（.env 文件）
- [ ] 9.2.5 设置备份定时任务（cron）
- [ ] 9.2.6 配置系统服务（systemd）

**预期产出**：
- 部署检查清单
- systemd 服务配置文件

---

### 9.3 数据迁移上线 🔗（依赖 9.2）
- [ ] 9.3.1 备份生产环境数据
- [ ] 9.3.2 停止旧版本服务
- [ ] 9.3.3 执行数据迁移脚本
- [ ] 9.3.4 验证数据完整性
- [ ] 9.3.5 启动新版本服务
- [ ] 9.3.6 监控服务运行状态
- [ ] 9.3.7 验证核心功能可用

**预期产出**：
- 上线报告
- 监控日志

---

## 10. 上线后优化

### 10.1 性能监控 🔗（上线后 1 周）
- [ ] 10.1.1 监控数据库文件大小增长
- [ ] 10.1.2 监控搜索响应时间
- [ ] 10.1.3 监控上传队列长度
- [ ] 10.1.4 收集用户反馈
- [ ] 10.1.5 识别性能瓶颈

**预期产出**：
- 性能监控报告

---

### 10.2 问题修复和优化 🔗（依赖 10.1）
- [ ] 10.2.1 修复用户反馈的 Bug
- [ ] 10.2.2 优化慢查询
- [ ] 10.2.3 调整索引策略（如有需要）
- [ ] 10.2.4 优化前端交互体验
- [ ] 10.2.5 更新文档

**预期产出**：
- Bug 修复列表
- 性能优化报告

---

## 验收标准

### 功能验收
- ✅ 可以创建和管理项目
- ✅ 上传图片到指定项目或永久库
- ✅ 项目内搜索响应时间 < 1 秒
- ✅ 永久库搜索响应时间 < 3 秒
- ✅ 可以将项目图片归档到永久库
- ✅ 归档后向量特征完整保留
- ✅ 文件路径保持不变（NAS 上）
- ✅ 备份和恢复流程正常工作

### 性能验收
- ✅ 支持 50+ 项目并行管理
- ✅ 并发上传无冲突（队列机制）
- ✅ 宽高比计算准确率 100%
- ✅ 数据迁移零丢失

### 文档验收
- ✅ 用户操作手册完整
- ✅ API 文档更新
- ✅ 部署文档清晰

---

## 预估工作量

| 阶段 | 预估时间 | 关键任务 |
|------|---------|---------|
| 1. 数据库设计 | 2 天 | Schema 设计、迁移脚本 |
| 2. 项目管理 | 2 天 | 项目 CRUD、API |
| 3. 素材上传 | 1 天 | 扩展扫描、队列机制 |
| 4. 搜索增强 | 2 天 | 多库搜索、结果合并 |
| 5. 归档功能 | 1.5 天 | 归档逻辑、API |
| 6. 前端界面 | 2 天 | 项目选择器、管理页面 |
| 7. 配置工具 | 1 天 | 备份脚本、CLI 工具 |
| 8. 测试验证 | 2 天 | 单元测试、集成测试 |
| 9. 文档部署 | 1.5 天 | 文档、部署配置 |
| **总计** | **15 天** | **约 3 周（含缓冲）** |

---

## 风险与依赖

### 高风险任务
- 🔴 1.3 数据迁移：涉及现有数据，需谨慎操作
- 🔴 9.3 生产环境上线：影响用户使用

### 阻塞性依赖
- 所有功能依赖 1.2（多数据库管理）
- 前端功能依赖对应的后端 API
- 部署依赖所有测试通过

### 并行机会
- 前端开发可与后端并行
- 文档编写可贯穿全程
- 备份脚本可独立开发
